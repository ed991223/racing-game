<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>NEON DRIFT - Cyberpunk Racer</title>
<style>
  @import url('https://fonts.googleapis.com/css2?family=Orbitron:wght@400;700;900&family=Rajdhani:wght@500;700&display=swap');
  *{margin:0;padding:0;box-sizing:border-box}
  body{background:#020210;display:flex;justify-content:center;align-items:center;min-height:100vh;overflow:hidden;font-family:'Rajdhani',sans-serif}
  #wrap{position:relative;display:flex;flex-direction:column;align-items:center}
  canvas{border-radius:4px;box-shadow:0 0 60px rgba(0,255,255,0.06),0 0 100px rgba(80,0,200,0.04)}
  #hud{position:absolute;top:10px;left:0;right:0;display:flex;justify-content:space-between;padding:0 16px;pointer-events:none;z-index:2}
  .hb{background:rgba(5,5,20,0.7);border:1px solid rgba(0,255,255,0.2);border-radius:4px;padding:5px 14px;color:rgba(0,255,255,0.7);font-family:'Orbitron',monospace;font-size:12px;backdrop-filter:blur(6px);box-shadow:0 0 10px rgba(0,255,255,0.06);text-shadow:0 0 6px rgba(0,255,255,0.3)}
  .hb span{color:#0ff;font-weight:700;font-size:17px}
  .ov{position:absolute;inset:0;display:flex;flex-direction:column;justify-content:center;align-items:center;background:rgba(3,3,14,0.88);border-radius:4px;z-index:10;backdrop-filter:blur(10px)}
  #os{display:none}#ni{display:none;z-index:20}
  .tt{font-family:'Orbitron',monospace;font-size:36px;font-weight:900;letter-spacing:6px;background:linear-gradient(90deg,#0ff,#a855f7,#0ff);background-size:200% 100%;-webkit-background-clip:text;-webkit-text-fill-color:transparent;animation:sh 3s ease-in-out infinite;filter:drop-shadow(0 0 20px rgba(0,255,255,0.4));margin-bottom:4px}
  @keyframes sh{0%,100%{background-position:0% 50%}50%{background-position:100% 50%}}
  .st{font-size:15px;color:rgba(168,85,247,0.6);margin-bottom:18px;letter-spacing:3px}
  .bt{font-family:'Orbitron',monospace;font-size:14px;background:transparent;color:#0ff;border:1px solid rgba(0,255,255,0.4);padding:10px 36px;border-radius:4px;cursor:pointer;letter-spacing:3px;transition:all .25s;box-shadow:0 0 20px rgba(0,255,255,0.1);text-shadow:0 0 10px rgba(0,255,255,0.6);margin-top:6px}
  .bt:hover{background:rgba(0,255,255,0.08);box-shadow:0 0 30px rgba(0,255,255,0.25);border-color:#0ff}
  .fs{font-family:'Orbitron',monospace;font-size:46px;color:#0ff;font-weight:900;margin:4px 0;text-shadow:0 0 30px rgba(0,255,255,0.5)}
  .ky{color:rgba(168,85,247,0.35);font-size:12px;margin-top:10px;letter-spacing:1px}
  .lu{position:absolute;top:50%;left:50%;transform:translate(-50%,-50%);font-family:'Orbitron',monospace;font-size:28px;font-weight:900;color:#0ff;text-shadow:0 0 30px #0ff,0 0 60px rgba(0,255,255,0.4);pointer-events:none;z-index:5;opacity:0;transition:opacity .3s}
  .music-btn{position:absolute;bottom:10px;right:14px;z-index:3;background:rgba(5,5,20,0.7);border:1px solid rgba(168,85,247,0.3);border-radius:4px;padding:4px 10px;color:rgba(168,85,247,0.7);font:11px 'Orbitron',monospace;cursor:pointer;transition:all .2s;text-shadow:0 0 4px rgba(168,85,247,0.3)}
  .music-btn:hover{border-color:#a855f7;color:#a855f7}
  /* ═══ 하트 UI ═══ */
  .hearts{display:flex;gap:3px;align-items:center}
  .ht{font-size:16px;transition:all .3s;filter:drop-shadow(0 0 6px rgba(255,0,170,0.6))}
  .ht.on{color:#ff00aa;text-shadow:0 0 8px rgba(255,0,170,0.5)}
  .ht.off{color:rgba(60,20,40,0.5);filter:none;transform:scale(0.85);text-shadow:none}
  .ht.pop{animation:htPop .4s ease-out}
  @keyframes htPop{0%{transform:scale(1.4);filter:drop-shadow(0 0 14px #ff00aa)}100%{transform:scale(0.85);filter:none}}
  /* 리더보드 */
  .lb-wrap{width:260px;margin:10px auto 4px;padding:10px 0 6px;background:rgba(5,3,20,0.6);border:1px solid rgba(0,255,255,0.12);border-radius:6px;box-shadow:0 0 20px rgba(0,255,255,0.04),inset 0 0 30px rgba(0,0,0,0.3)}
  .lb-title{font-family:'Orbitron',monospace;font-size:12px;font-weight:700;color:#a855f7;letter-spacing:3px;text-align:center;text-shadow:0 0 8px rgba(168,85,247,0.4);margin-bottom:8px;text-transform:uppercase}
  .lb-row{display:flex;align-items:center;padding:3px 16px;font-family:'Rajdhani',sans-serif;font-size:14px}
  .lb-row.highlight{background:rgba(0,255,255,0.06);border-left:2px solid #0ff;padding-left:14px}
  .lb-rank{width:22px;font-family:'Orbitron',monospace;font-size:12px;font-weight:700;color:#a855f7;text-shadow:0 0 6px rgba(168,85,247,0.3)}
  .lb-rank.gold{color:#ffd700;text-shadow:0 0 10px rgba(255,215,0,0.4)}
  .lb-rank.silver{color:#c0c0c0;text-shadow:0 0 8px rgba(192,192,192,0.3)}
  .lb-rank.bronze{color:#cd7f32;text-shadow:0 0 8px rgba(205,127,50,0.3)}
  .lb-name{flex:1;color:rgba(220,230,255,0.75);overflow:hidden;text-overflow:ellipsis;white-space:nowrap;padding:0 8px}
  .lb-score{font-family:'Orbitron',monospace;font-size:13px;font-weight:700;color:#0ff;text-shadow:0 0 6px rgba(0,255,255,0.3)}
  .lb-empty{text-align:center;color:rgba(168,85,247,0.3);font-size:12px;padding:8px 0;font-style:italic}
  .lb-new{animation:lbPulse 1s ease-in-out infinite}
  @keyframes lbPulse{0%,100%{text-shadow:0 0 6px rgba(0,255,255,0.3)}50%{text-shadow:0 0 16px rgba(0,255,255,0.7)}}
  .ni-box{background:rgba(8,4,28,0.95);border:1px solid rgba(0,255,255,0.2);border-radius:8px;padding:24px 30px;text-align:center;box-shadow:0 0 40px rgba(0,255,255,0.08),0 0 80px rgba(168,85,247,0.05)}
  .ni-title{font-family:'Orbitron',monospace;font-size:16px;font-weight:700;color:#0ff;letter-spacing:2px;margin-bottom:4px;text-shadow:0 0 12px rgba(0,255,255,0.4)}
  .ni-sub{font-size:13px;color:rgba(168,85,247,0.5);margin-bottom:14px;letter-spacing:1px}
  .ni-score{font-family:'Orbitron',monospace;font-size:32px;font-weight:900;color:#0ff;margin-bottom:14px;text-shadow:0 0 20px rgba(0,255,255,0.4)}
  .ni-input{width:180px;background:rgba(0,0,0,0.4);border:1px solid rgba(0,255,255,0.2);border-radius:4px;padding:8px 14px;color:#0ff;font-family:'Orbitron',monospace;font-size:14px;text-align:center;letter-spacing:2px;outline:none;caret-color:#0ff}
  .ni-input:focus{border-color:rgba(0,255,255,0.5);box-shadow:0 0 12px rgba(0,255,255,0.1)}
  .ni-input::placeholder{color:rgba(0,255,255,0.2)}
  .ni-btn{font-family:'Orbitron',monospace;font-size:12px;background:rgba(0,255,255,0.08);color:#0ff;border:1px solid rgba(0,255,255,0.3);padding:8px 28px;border-radius:4px;cursor:pointer;letter-spacing:2px;margin-top:12px;transition:all .2s}
  .ni-btn:hover{background:rgba(0,255,255,0.15);box-shadow:0 0 20px rgba(0,255,255,0.15)}

  /* ══════════════════════════════════
     ★ 전광판 (2/3 축소: 187×180)  ★
     ══════════════════════════════════ */
  .billboard{
    position:absolute;
    top:34px; right:-25px;
    width:187px; height:180px;
    z-index:1; pointer-events:none;
  }
  .bb-ambient{
    position:absolute;top:-14px;left:-20px;right:-20px;bottom:-26px;
    background:radial-gradient(ellipse at center 40%,rgba(255,0,170,0.03) 0%,rgba(0,255,255,0.012) 40%,transparent 65%);
    pointer-events:none;z-index:-1;animation:bbAmb 3s ease-in-out infinite;
  }
  @keyframes bbAmb{0%,100%{opacity:.5}50%{opacity:1}}
  .bb-pole{
    position:absolute;bottom:-24px;width:4px;height:24px;
    background:linear-gradient(180deg,#4a4a60 0%,#2a2a3a 40%,#1a1a28 100%);
    border:1px solid rgba(0,255,255,0.04);border-radius:1px;
    box-shadow:0 0 4px rgba(0,0,0,0.6);
  }
  .bb-pole.left{left:19px}.bb-pole.right{right:19px}
  .bb-pole::before{content:'';position:absolute;top:2px;left:50%;transform:translateX(-50%);width:5px;height:5px;border-radius:50%;background:#3a3a50;border:1px solid rgba(0,255,255,0.08)}
  .bb-pole::after{content:'';position:absolute;bottom:2px;left:50%;transform:translateX(-50%);width:5px;height:5px;border-radius:50%;background:#3a3a50;border:1px solid rgba(0,255,255,0.06)}
  .bb-frame{
    position:relative;width:100%;height:140px;
    background:linear-gradient(180deg,#0e0e24,#0a0a1c,#060616);
    border:2px solid #2e2e48;border-radius:3px;
    box-shadow:0 0 14px rgba(0,255,255,0.1),0 0 35px rgba(168,85,247,0.07),0 0 55px rgba(255,0,170,0.04),inset 0 0 18px rgba(0,0,0,0.9);
    overflow:hidden;
  }
  .bb-frame::before{content:'';position:absolute;inset:-2px;border:1px solid rgba(255,255,255,0.05);border-radius:4px;pointer-events:none;z-index:5}
  .bb-frame::after{content:'';position:absolute;inset:-4px;border-radius:5px;pointer-events:none;z-index:4;border:2px solid transparent;animation:bbFlk 2.2s ease-in-out infinite}
  @keyframes bbFlk{
    0%,100%{border-color:rgba(255,0,170,0.7);box-shadow:0 0 8px rgba(255,0,170,0.3),0 0 20px rgba(255,0,170,0.1)}
    20%{border-color:rgba(0,255,255,0.1);box-shadow:none}
    25%{border-color:rgba(0,255,255,0.8);box-shadow:0 0 10px rgba(0,255,255,0.35),0 0 24px rgba(0,255,255,0.12)}
    30%{border-color:rgba(0,255,255,0.05);box-shadow:none}
    50%{border-color:rgba(0,255,255,0.9);box-shadow:0 0 12px rgba(0,255,255,0.45),0 0 28px rgba(0,255,255,0.15)}
    60%{border-color:rgba(255,0,170,0.1);box-shadow:none}
    65%{border-color:rgba(255,0,170,0.8);box-shadow:0 0 10px rgba(255,0,170,0.35),0 0 24px rgba(255,0,170,0.12)}
    70%{border-color:rgba(255,0,170,0.05);box-shadow:none}
  }
  .bb-neon-top{position:absolute;top:-2px;left:10px;right:10px;height:2px;background:#ff00aa;border-radius:2px;z-index:6;box-shadow:0 0 8px #ff00aa,0 0 18px rgba(255,0,170,0.45),0 0 36px rgba(255,0,170,0.18);animation:bbNT 1.5s ease-in-out infinite}
  @keyframes bbNT{0%,100%{opacity:.6;box-shadow:0 0 6px #ff00aa,0 0 12px rgba(255,0,170,0.25)}50%{opacity:1;box-shadow:0 0 10px #ff00aa,0 0 22px rgba(255,0,170,0.45),0 0 44px rgba(255,0,170,0.18)}}
  .bb-neon-bot{position:absolute;bottom:-2px;left:10px;right:10px;height:2px;background:#0ff;border-radius:2px;z-index:6;box-shadow:0 0 8px #0ff,0 0 18px rgba(0,255,255,0.45),0 0 36px rgba(0,255,255,0.18);animation:bbNB 1.8s ease-in-out infinite}
  @keyframes bbNB{0%,100%{opacity:.5;box-shadow:0 0 6px #0ff,0 0 12px rgba(0,255,255,0.25)}50%{opacity:1;box-shadow:0 0 10px #0ff,0 0 25px rgba(0,255,255,0.45),0 0 48px rgba(0,255,255,0.18)}}
  .bb-neon-l{position:absolute;top:10px;bottom:10px;left:-2px;width:2px;background:linear-gradient(180deg,#ff00aa,#a855f7,#0ff,#a855f7,#ff00aa);border-radius:2px;z-index:6;box-shadow:0 0 6px rgba(255,0,170,0.35),0 0 12px rgba(0,255,255,0.25);animation:bbNS 2.5s ease-in-out infinite}
  .bb-neon-r{position:absolute;top:10px;bottom:10px;right:-2px;width:2px;background:linear-gradient(180deg,#0ff,#a855f7,#ff00aa,#a855f7,#0ff);border-radius:2px;z-index:6;box-shadow:0 0 6px rgba(0,255,255,0.35),0 0 12px rgba(255,0,170,0.25);animation:bbNS 2.5s ease-in-out infinite;animation-delay:.8s}
  @keyframes bbNS{0%,100%{opacity:.5}30%{opacity:.15}50%{opacity:1}70%{opacity:.2}}
  .bb-dot{position:absolute;width:4px;height:4px;border-radius:50%;z-index:7;animation:bbDP 1.2s ease-in-out infinite}
  .bb-dot.tl{top:3px;left:3px;background:#ff00aa;box-shadow:0 0 6px #ff00aa,0 0 12px rgba(255,0,170,0.35)}
  .bb-dot.tr{top:3px;right:3px;background:#0ff;box-shadow:0 0 6px #0ff,0 0 12px rgba(0,255,255,0.35);animation-delay:.3s}
  .bb-dot.bl{bottom:3px;left:3px;background:#0ff;box-shadow:0 0 6px #0ff,0 0 12px rgba(0,255,255,0.35);animation-delay:.6s}
  .bb-dot.br{bottom:3px;right:3px;background:#ff00aa;box-shadow:0 0 6px #ff00aa,0 0 12px rgba(255,0,170,0.35);animation-delay:.9s}
  .bb-dot.ml{top:50%;left:3px;transform:translateY(-50%);background:#a855f7;box-shadow:0 0 5px #a855f7,0 0 10px rgba(168,85,247,0.35);animation-delay:.4s}
  .bb-dot.mr{top:50%;right:3px;transform:translateY(-50%);background:#a855f7;box-shadow:0 0 5px #a855f7,0 0 10px rgba(168,85,247,0.35);animation-delay:.7s}
  @keyframes bbDP{0%,100%{opacity:.25;transform:scale(.7)}50%{opacity:1;transform:scale(1.3)}}
  .bb-screen{position:absolute;top:4px;left:4px;right:4px;bottom:20px;border-radius:2px;overflow:hidden;background:#000}
  .bb-screen iframe{width:100%!important;height:100%!important;border:none;pointer-events:none;display:block}
  .bb-screen::after{content:'';position:absolute;inset:0;background:linear-gradient(135deg,rgba(255,255,255,0.04) 0%,transparent 30%,transparent 70%,rgba(0,255,255,0.025) 100%);pointer-events:none;z-index:2}
  .bb-screen::before{content:'';position:absolute;inset:0;z-index:2;pointer-events:none;background:repeating-linear-gradient(0deg,transparent,transparent 2px,rgba(0,0,0,0.05) 2px,rgba(0,0,0,0.05) 4px)}
  .bb-label{position:absolute;bottom:0;left:0;right:0;height:18px;display:flex;align-items:center;justify-content:center;background:linear-gradient(180deg,rgba(10,6,30,0.4),rgba(8,4,24,0.95));border-top:1px solid rgba(255,0,170,0.2);z-index:3}
  .bb-label span{font-family:'Orbitron',monospace;font-size:6.5px;font-weight:700;color:#ff00aa;letter-spacing:3px;text-transform:uppercase;text-shadow:0 0 6px rgba(255,0,170,0.5);animation:bbTG 2s ease-in-out infinite}
  @keyframes bbTG{0%,100%{color:#ff00aa;text-shadow:0 0 6px rgba(255,0,170,0.5)}50%{color:#0ff;text-shadow:0 0 8px rgba(0,255,255,0.5)}}
  .bb-glow{position:absolute;top:140px;left:50%;transform:translateX(-50%);width:133px;height:53px;background:radial-gradient(ellipse at top,rgba(255,0,170,0.06) 0%,rgba(0,255,255,0.025) 35%,transparent 70%);pointer-events:none}
  .bb-rivet{position:absolute;width:6px;height:6px;border-radius:50%;z-index:8;background:radial-gradient(circle at 35% 35%,#5a5a70,#2a2a40);border:1px solid rgba(0,255,255,0.06);box-shadow:inset 0 1px 2px rgba(255,255,255,0.08),0 0 3px rgba(0,0,0,0.5)}
  .bb-rivet.tl{top:5px;left:5px}.bb-rivet.tr{top:5px;right:5px}.bb-rivet.bl{bottom:22px;left:5px}.bb-rivet.br{bottom:22px;right:5px}
</style>
</head>
<body>
<div id="wrap">
  <canvas id="c"></canvas>
  <div id="hud">
    <div class="hb"><div class="hearts"><span class="ht on" id="h0">♥</span><span class="ht on" id="h1">♥</span><span class="ht on" id="h2">♥</span></div></div>
    <div class="hb">SCORE <span id="sv">0</span></div>
    <div class="hb">SPEED <span id="sp">60</span> km/h</div>
  </div>
  <div class="lu" id="lu">SPEED UP!</div>
  <button class="music-btn" id="musicBtn">♫ ON</button>

  <!-- ★ 전광판 (2/3 축소) ★ -->
  <div class="billboard">
    <div class="bb-ambient"></div>
    <div class="bb-pole left"></div>
    <div class="bb-pole right"></div>
    <div class="bb-frame">
      <div class="bb-neon-top"></div><div class="bb-neon-bot"></div>
      <div class="bb-neon-l"></div><div class="bb-neon-r"></div>
      <div class="bb-dot tl"></div><div class="bb-dot tr"></div>
      <div class="bb-dot bl"></div><div class="bb-dot br"></div>
      <div class="bb-dot ml"></div><div class="bb-dot mr"></div>
      <div class="bb-rivet tl"></div><div class="bb-rivet tr"></div>
      <div class="bb-rivet bl"></div><div class="bb-rivet br"></div>
      <div class="bb-screen"><div id="ytFrame"></div></div>
      <div class="bb-label"><span>★ PLAVE LIVE ★</span></div>
    </div>
    <div class="bb-glow"></div>
  </div>

  <div class="ov" id="ss">
    <div class="tt">NEON DRIFT</div>
    <div class="st">C Y B E R P U N K &nbsp; R A C E R</div>
    <div id="ssLB"></div>
    <button class="bt" id="sb">START</button>
    <div class="ky">↑ ↓ ← → 방향키 또는 W A S D 키로 조작</div>
  </div>
  <div class="ov" id="os">
    <div class="tt" style="font-size:30px">WASTED</div>
    <div class="st">FINAL SCORE</div>
    <div class="fs" id="fsc">0</div>
    <div id="osLB"></div>
    <button class="bt" id="rb">RETRY</button>
    <div class="ky">R키로 즉시 재시작</div>
  </div>
  <div class="ov" id="ni">
    <div class="ni-box">
      <div class="ni-title">★ NEW RECORD ★</div>
      <div class="ni-sub">TOP 5 진입!</div>
      <div class="ni-score" id="niScore">0</div>
      <input class="ni-input" id="niInput" type="text" maxlength="8" placeholder="이름 입력" autocomplete="off"><br>
      <button class="ni-btn" id="niBtn">SAVE</button>
    </div>
  </div>
</div>

<!-- ══════════════════════════════════════════════
     ★★ YouTube: Error 153 해결 (nocookie + origin + referrerpolicy) ★★
     ══════════════════════════════════════════════ -->
<script>
  let musicOn=true,ytReady=false,ytP=null;
  let ytRetryCount=0;
  const YT_VIDEO_ID='eHCYzIu-ij4';

  const ytTag=document.createElement('script');
  ytTag.src='https://www.youtube.com/iframe_api';
  document.head.appendChild(ytTag);

  function onYouTubeIframeAPIReady(){
    createPlayer();
  }

  function createPlayer(){
    const scr=document.querySelector('.bb-screen');
    const sw=scr?scr.clientWidth:179;
    const sh=scr?scr.clientHeight:116;

    ytP=new YT.Player('ytFrame',{
      width:String(sw),
      height:String(sh),
      videoId:YT_VIDEO_ID,
      // ★★ Error 153 핵심 수정: youtube-nocookie.com 사용 ★★
      host:'https://www.youtube-nocookie.com',
      playerVars:{
        autoplay:1,
        mute:1,                      // 브라우저 정책: 음소거 시작 필수
        loop:1,
        playlist:YT_VIDEO_ID,        // loop:1에 필수
        controls:0,
        disablekb:1,
        fs:0,
        rel:0,
        playsinline:1,
        modestbranding:1,
        showinfo:0,
        // ★★ Error 153 핵심 수정: origin 명시 ★★
        origin:window.location.origin||window.location.protocol+'//'+window.location.host,
        enablejsapi:1
      },
      events:{
        onReady:function(e){
          ytReady=true;
          ytRetryCount=0;
          e.target.setVolume(100);
          e.target.playVideo();
          // ★★ Error 153 핵심 수정: iframe에 referrerpolicy 속성 추가 ★★
          try{
            const iframe=document.querySelector('#ytFrame iframe')||document.querySelector('.bb-screen iframe');
            if(iframe){
              iframe.setAttribute('referrerpolicy','strict-origin-when-cross-origin');
              iframe.setAttribute('allow','autoplay; encrypted-media');
            }
          }catch(e){}
        },
        onStateChange:function(e){
          if(e.data===YT.PlayerState.ENDED){
            e.target.seekTo(0);
            e.target.playVideo();
          }
        },
        // ★★ Error 153 에러 핸들러: 자동 재시도 ★★
        onError:function(e){
          console.warn('YT Error:',e.data);
          if(ytRetryCount<3){
            ytRetryCount++;
            setTimeout(function(){
              try{
                // 기존 플레이어 제거 후 재생성
                if(ytP&&ytP.destroy)ytP.destroy();
              }catch(ex){}
              ytReady=false;
              // div 복원
              const scr=document.querySelector('.bb-screen');
              if(scr&&!document.getElementById('ytFrame')){
                const d=document.createElement('div');
                d.id='ytFrame';
                scr.appendChild(d);
              }
              createPlayer();
            },1500*ytRetryCount);
          }
        }
      }
    });
  }

  // ★ playMusic: 반드시 사용자 클릭 이벤트 안에서 호출
  function playMusic(){
    if(!musicOn)return;
    if(ytReady&&ytP){
      try{
        ytP.setVolume(100);
        ytP.unMute();
        ytP.playVideo();
      }catch(e){}
    } else {
      setTimeout(playMusic,500);
    }
  }
  function stopMusic(){if(ytReady&&ytP)try{ytP.mute()}catch(e){}}
  function toggleMusic(){
    musicOn=!musicOn;
    document.getElementById('musicBtn').textContent=musicOn?'♫ ON':'♫ OFF';
    if(!ytReady||!ytP)return;
    try{if(musicOn){ytP.unMute();ytP.setVolume(100);ytP.playVideo()}else{ytP.mute()}}catch(e){}
  }
  document.getElementById('musicBtn').addEventListener('click',toggleMusic);
</script>

<!-- ══════ 게임 ══════ -->
<script>
const canvas=document.getElementById('c'),ctx=canvas.getContext('2d');
const W=480,H=760;canvas.width=W;canvas.height=H;
const ROAD_L=90,ROAD_R=W-90,ROAD_W=ROAD_R-ROAD_L,LANE_W=ROAD_W/4;
const LB_KEY='neonDriftLB',LB_MAX=5;
let generation=0;
let run=0,dead=0,score=0,speed=1.5,frame=0,lastLv=0,roadOff=0,gridOff=0;
const kp={};const car={x:W/2,y:H-110,w:38,h:72};
let obstacles=[],particles=[],pendingScore=null;
let lives=3,invincible=0,invTimer=0;

// ═══ 리더보드 ═══
function lbLoad(){try{const d=localStorage.getItem(LB_KEY);if(d){const a=JSON.parse(d);if(Array.isArray(a))return a.slice(0,LB_MAX)}}catch(e){}return[]}
function lbSave(a){try{localStorage.setItem(LB_KEY,JSON.stringify(a.slice(0,LB_MAX)))}catch(e){}}
function lbQualifies(sc){const lb=lbLoad();return lb.length<LB_MAX||sc>lb[lb.length-1].score}
function lbInsert(name,sc){const lb=lbLoad();lb.push({name:name||'???',score:sc});lb.sort((a,b)=>b.score-a.score);const t=lb.slice(0,LB_MAX);lbSave(t);return t}
function lbRender(tid,hl){const lb=lbLoad(),el=document.getElementById(tid);if(!el)return;if(!lb.length){el.innerHTML='<div class="lb-wrap"><div class="lb-title">LEADERBOARD</div><div class="lb-empty">아직 기록이 없습니다</div></div>';return}let h='<div class="lb-wrap"><div class="lb-title">LEADERBOARD</div>';lb.forEach((e,i)=>{const rc=i===0?'gold':i===1?'silver':i===2?'bronze':'';const isH=hl!=null&&e.score===hl;h+=`<div class="lb-row${isH?' highlight':''}"><div class="lb-rank ${rc}">${i+1}</div><div class="lb-name">${escH(e.name)}</div><div class="lb-score${isH?' lb-new':''}">${e.score}</div></div>`});el.innerHTML=h+'</div>'}
function escH(s){return String(s).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;')}

// ═══ 빌딩 ═══
let bldL=[],bldR=[];
function mkBld(side){const w=18+Math.random()*28,h=35+Math.random()*65;const x=side==='l'?Math.random()*(ROAD_L-w-4):ROAD_R+4+Math.random()*(W-ROAD_R-w-4);const neons=[];for(let i=0;i<1+~~(Math.random()*3);i++)neons.push({ry:.15+Math.random()*.55,rw:.25+Math.random()*.5,c:['#0ff','#a855f7','#ff00aa','#00ff88','#0af'][~~(Math.random()*5)],b:Math.random()*6.28,s:.008+Math.random()*.025});return{x,y:-h,w,h,neons,wr:Math.max(1,~~(h/11)),wc:Math.max(1,~~(w/8)),win:Math.random()>.25,bc:`rgb(${5+~~(Math.random()*10)},${5+~~(Math.random()*8)},${15+~~(Math.random()*15)})`}}
function initBld(){bldL=[];bldR=[];let ly=-80;while(ly<H+80){const b=mkBld('l');b.y=ly;bldL.push(b);ly+=b.h+3+Math.random()*8}let ry=-80;while(ry<H+80){const b=mkBld('r');b.y=ry;bldR.push(b);ry+=b.h+3+Math.random()*8}}
initBld();
let mono={x:-220,y:0,s:.6,on:0,t:0};

// ═══ 입력 ═══
document.addEventListener('keydown',e=>{if(document.getElementById('ni').style.display==='flex'){if(e.key==='Enter')submitName();return}kp[e.key]=1;if((e.key==='r'||e.key==='R')&&dead)restart();if((e.key===' '||e.key==='Enter')&&!run&&!dead)startGame()});
document.addEventListener('keyup',e=>{kp[e.key]=0});
document.getElementById('sb').onclick=startGame;
document.getElementById('rb').onclick=restart;
document.getElementById('niBtn').onclick=submitName;
let touchX=null,touchY=null;
canvas.addEventListener('touchstart',e=>{e.preventDefault();touchX=e.touches[0].clientX;touchY=e.touches[0].clientY});
canvas.addEventListener('touchmove',e=>{e.preventDefault();if(touchX!==null){const dx=e.touches[0].clientX-touchX,dy=e.touches[0].clientY-touchY;if(Math.abs(dx)>8){car.x+=dx>0?5:-5;touchX=e.touches[0].clientX}if(Math.abs(dy)>8){car.y+=dy>0?5:-5;touchY=e.touches[0].clientY}}});
canvas.addEventListener('touchend',()=>{touchX=null;touchY=null});

function showNameInput(sc){pendingScore=sc;document.getElementById('niScore').textContent=sc;document.getElementById('niInput').value='';document.getElementById('ni').style.display='flex';setTimeout(()=>document.getElementById('niInput').focus(),100)}
function submitName(){let name=document.getElementById('niInput').value.trim();if(!name)name='RACER';if(name.length>8)name=name.slice(0,8);document.getElementById('ni').style.display='none';lbInsert(name,pendingScore);showGameOver(pendingScore);pendingScore=null}
function showGameOver(sc){document.getElementById('fsc').textContent=sc;lbRender('osLB',sc);document.getElementById('os').style.display='flex'}

// ═══════════════════════════════════════════════
//  ★★ 게임 초기화 — 모든 값을 숫자 리터럴로 직접 할당 ★★
// ═══════════════════════════════════════════════
function resetAll(){
  generation++;        // ★ 이전 루프 즉시 사멸 (세대 교체)

  run       = 1;       // 게임 실행 중
  dead      = 0;       // 사망 아님
  score     = 0;       // 점수 0
  speed     = 1.5;     // ★★ 숫자 리터럴 1.5 (절대 초기 속도)
  frame     = 0;       // 프레임 카운터 0
  lastLv    = 0;       // 레벨업 기록 0
  roadOff   = 0;       // 도로 대시 오프셋 0
  gridOff   = 0;       // 그리드 오프셋 0

  car.x     = 240;     // ★ W/2 = 240 (리터럴)
  car.y     = 650;     // ★ H-110 = 650 (리터럴)

  obstacles = [];      // ★ 장애물 전부 제거
  particles = [];      // 파티클 전부 제거
  lives     = 3;       // ★ 생명 풀 충전
  invincible= 0;       // ★ 무적 해제
  invTimer  = 0;       // ★ 무적 타이머 0

  // 키 상태 전체 초기화 (누르던 키 해제)
  for(const k in kp) kp[k] = 0;

  initBld();           // 빌딩 재생성
  mono = {x:-220, y:0, s:0.6, on:0, t:0};  // 모노레일 초기화

  document.getElementById('sv').textContent = '0';
  document.getElementById('sp').textContent = '60';
  updateHearts();        // ★ 하트 UI 복원
}

function startGame(){
  document.getElementById('ss').style.display='none';
  document.getElementById('ni').style.display='none';
  resetAll();
  playMusic();  // ★ 클릭 이벤트 스택에서 호출 → unMute 허용
  requestAnimationFrame(()=>loop(generation));
}
function restart(){
  document.getElementById('os').style.display='none';
  document.getElementById('ni').style.display='none';
  resetAll();
  playMusic();
  requestAnimationFrame(()=>loop(generation));
}
// ═══ 하트 UI 업데이트 ═══
function updateHearts(){
  for(let i=0;i<3;i++){
    const el=document.getElementById('h'+i);
    if(i<lives){el.className='ht on'}
    else{el.className='ht off'}
  }
}
function popHeart(idx){
  const el=document.getElementById('h'+idx);
  el.className='ht off pop';
}

// ═══ 충돌 처리 (생명 시스템) ═══
function hit(hitObs){
  if(invincible)return;      // 무적 중이면 무시
  lives--;
  popHeart(lives);           // 하트 애니메이션
  // 작은 파티클 (피격 효과)
  for(let i=0;i<15;i++)particles.push({x:car.x,y:car.y+car.h/2,vx:(Math.random()-.5)*7,vy:(Math.random()-.5)*7,r:1.5+Math.random()*3,life:0.7,c:['#ff00aa','#a855f7','#fff'][~~(Math.random()*3)]});
  // 부딪힌 장애물 제거
  const idx=obstacles.indexOf(hitObs);
  if(idx!==-1)obstacles.splice(idx,1);

  if(lives<=0){
    die();  // 생명 0 → 게임 오버
  } else {
    // 무적 시작: 1.5초 (90프레임 @60fps)
    invincible=1;
    invTimer=90;
  }
}
function die(){
  dead=1;run=0;
  const fs=score;
  for(let i=0;i<40;i++)particles.push({x:car.x,y:car.y+car.h/2,vx:(Math.random()-.5)*10,vy:(Math.random()-.5)*10,r:2+Math.random()*5,life:1,c:['#0ff','#a855f7','#ff00aa','#fff','#00ff88'][~~(Math.random()*5)]});
  setTimeout(()=>{if(fs>0&&lbQualifies(fs))showNameInput(fs);else showGameOver(fs)},900);
}
function spawn(){const type=['cone','rock','barrel'][~~(Math.random()*3)];const margin=18,cx=ROAD_L+margin+Math.random()*(ROAD_W-margin*2);let w,h;if(type==='cone'){w=24;h=30}else if(type==='rock'){w=36;h=28}else{w=28;h=32}obstacles.push({type,x:cx,y:-50,w,h})}
function showLv(){const e=document.getElementById('lu');e.style.opacity='1';setTimeout(()=>e.style.opacity='0',1200)}

// ═══ 그리기 ═══
function drawBg(){ctx.fillStyle='#04041a';ctx.fillRect(0,0,W,H)}
function drawScrollBld(arr){for(const b of arr){const bg=ctx.createLinearGradient(b.x,b.y,b.x+b.w,b.y+b.h);bg.addColorStop(0,b.bc);bg.addColorStop(1,'#040412');ctx.fillStyle=bg;ctx.fillRect(b.x,b.y,b.w,b.h);ctx.strokeStyle='rgba(0,255,255,.04)';ctx.lineWidth=.5;ctx.strokeRect(b.x,b.y,b.w,b.h);if(b.win){const ww=4,wh=5,gX=Math.max(6,(b.w-4)/b.wc),gY=Math.max(8,(b.h-6)/b.wr);for(let r=0;r<b.wr;r++)for(let c=0;c<b.wc;c++){const wx=b.x+3+c*gX,wy=b.y+4+r*gY;if(wy<b.y||wy+wh>b.y+b.h)continue;if(Math.sin(wx*5.3+wy*3.7+frame*.001)>.1){ctx.fillStyle=`rgba(0,255,255,${.03+Math.sin(wx*.3+wy*.2+frame*.004)*.02})`;ctx.fillRect(wx,wy,ww,wh)}else if(Math.sin(wx*2.1+wy*4.5)>.5){ctx.fillStyle='rgba(168,85,247,.02)';ctx.fillRect(wx,wy,ww,wh)}}}for(const n of b.neons){n.b+=n.s;const na=.4+Math.sin(n.b)*.4,ny=b.y+b.h*n.ry,nw=b.w*n.rw,nx=b.x+(b.w-nw)/2;if(ny<b.y||ny>b.y+b.h)continue;ctx.save();ctx.globalAlpha=na*.8;ctx.shadowColor=n.c;ctx.shadowBlur=14;ctx.fillStyle=n.c;ctx.fillRect(nx,ny,nw,2.5);ctx.restore();ctx.save();ctx.globalAlpha=na*.04;ctx.fillStyle=n.c;ctx.fillRect(nx-2,ny+3,nw+4,8);ctx.restore()}}}
function updBld(arr,side){const s=speed*2;for(const b of arr)b.y+=s;for(let i=arr.length-1;i>=0;i--){if(arr[i].y>H+10){arr.splice(i,1);const nb=mkBld(side);let topY=H;for(const b2 of arr)if(b2.y<topY)topY=b2.y;nb.y=topY-nb.h-3-Math.random()*8;arr.push(nb)}}}
function drawRoad(){const rg=ctx.createLinearGradient(ROAD_L,0,ROAD_R,0);rg.addColorStop(0,'#0d0d18');rg.addColorStop(.03,'#111120');rg.addColorStop(.97,'#111120');rg.addColorStop(1,'#0d0d18');ctx.fillStyle=rg;ctx.fillRect(ROAD_L,0,ROAD_W,H);gridOff=(gridOff+speed*1.8)%28;ctx.strokeStyle='rgba(0,255,255,.02)';ctx.lineWidth=.5;for(let gy=-28+gridOff;gy<H;gy+=28){ctx.beginPath();ctx.moveTo(ROAD_L+2,gy);ctx.lineTo(ROAD_R-2,gy);ctx.stroke()}for(let gx=ROAD_L+14;gx<ROAD_R;gx+=28){ctx.beginPath();ctx.moveTo(gx,0);ctx.lineTo(gx,H);ctx.stroke()}roadOff+=speed*2.5;ctx.save();ctx.strokeStyle='#0ff';ctx.lineWidth=2.5;ctx.shadowColor='#0ff';ctx.shadowBlur=18;ctx.beginPath();ctx.moveTo(ROAD_L,0);ctx.lineTo(ROAD_L,H);ctx.stroke();ctx.beginPath();ctx.moveTo(ROAD_R,0);ctx.lineTo(ROAD_R,H);ctx.stroke();ctx.restore();let rl=ctx.createLinearGradient(ROAD_L,0,ROAD_L+30,0);rl.addColorStop(0,'rgba(0,255,255,.04)');rl.addColorStop(1,'transparent');ctx.fillStyle=rl;ctx.fillRect(ROAD_L,0,30,H);let rr=ctx.createLinearGradient(ROAD_R,0,ROAD_R-30,0);rr.addColorStop(0,'rgba(0,255,255,.04)');rr.addColorStop(1,'transparent');ctx.fillStyle=rr;ctx.fillRect(ROAD_R-30,0,30,H);ctx.save();ctx.setLineDash([26,20]);ctx.lineDashOffset=-roadOff;ctx.strokeStyle='rgba(168,85,247,.3)';ctx.lineWidth=1.5;ctx.shadowColor='#a855f7';ctx.shadowBlur=5;for(let i=1;i<4;i++){const lx=ROAD_L+LANE_W*i;ctx.beginPath();ctx.moveTo(lx,0);ctx.lineTo(lx,H);ctx.stroke()}ctx.restore();if(speed>2){const la=Math.min((speed-2)*.03,.12);ctx.strokeStyle=`rgba(0,255,255,${la})`;ctx.lineWidth=.8;for(let i=0;i<5;i++){const sx=ROAD_L+15+Math.random()*(ROAD_W-30),sy=Math.random()*H;ctx.beginPath();ctx.moveTo(sx,sy);ctx.lineTo(sx,sy+15+speed*7);ctx.stroke()}}}
function drawMono(){mono.t++;if(!mono.on&&mono.t>350){mono.on=1;mono.x=-240;mono.t=0;mono.y=25+Math.random()*40;mono.s=.5+Math.random()*.4}if(!mono.on)return;mono.x+=mono.s;if(mono.x>W+260){mono.on=0;mono.t=0;return}const mx=mono.x,my=mono.y;ctx.strokeStyle='rgba(168,85,247,.15)';ctx.lineWidth=1.5;ctx.beginPath();ctx.moveTo(0,my+24);ctx.lineTo(W,my+24);ctx.stroke();const tg=ctx.createLinearGradient(mx,my,mx,my+22);tg.addColorStop(0,'#221545');tg.addColorStop(1,'#120a28');ctx.fillStyle=tg;ctx.beginPath();ctx.moveTo(mx+14,my);ctx.lineTo(mx+190,my);ctx.quadraticCurveTo(mx+200,my+11,mx+190,my+22);ctx.lineTo(mx+14,my+22);ctx.quadraticCurveTo(mx-2,my+11,mx+14,my);ctx.fill();ctx.save();for(let wx=mx+20;wx<mx+180;wx+=24){ctx.fillStyle='rgba(0,255,255,.45)';ctx.shadowColor='#0ff';ctx.shadowBlur=8;ctx.fillRect(wx,my+4,15,9)}ctx.restore();ctx.save();ctx.strokeStyle='#a855f7';ctx.lineWidth=2;ctx.shadowColor='#a855f7';ctx.shadowBlur=10;ctx.beginPath();ctx.moveTo(mx+10,my+22);ctx.lineTo(mx+194,my+22);ctx.stroke();ctx.restore()}
function drawCar(x,y){ctx.save();ctx.translate(x,y);const ug=ctx.createRadialGradient(0,50,4,0,50,42);ug.addColorStop(0,'rgba(0,255,255,.12)');ug.addColorStop(1,'transparent');ctx.fillStyle=ug;ctx.beginPath();ctx.ellipse(0,50,36,16,0,0,6.28);ctx.fill();ctx.fillStyle='#15153a';ctx.fillRect(-22,58,44,5);ctx.save();ctx.fillStyle='#0ff';ctx.shadowColor='#0ff';ctx.shadowBlur=6;ctx.fillRect(-22,63,44,1.5);ctx.restore();ctx.fillStyle='#0e0e14';ctx.fillRect(-22,40,8,18);ctx.fillRect(14,40,8,18);ctx.fillStyle='#282830';ctx.fillRect(-21,43,6,3);ctx.fillRect(15,43,6,3);ctx.fillRect(-21,51,6,3);ctx.fillRect(15,51,6,3);const bg=ctx.createLinearGradient(0,-30,0,55);bg.addColorStop(0,'#180e3a');bg.addColorStop(.4,'#10082a');bg.addColorStop(1,'#080420');ctx.fillStyle=bg;ctx.beginPath();ctx.moveTo(0,-34);ctx.lineTo(-10,-20);ctx.lineTo(-14,10);ctx.lineTo(-12,50);ctx.lineTo(-8,58);ctx.lineTo(8,58);ctx.lineTo(12,50);ctx.lineTo(14,10);ctx.lineTo(10,-20);ctx.closePath();ctx.fill();ctx.save();ctx.strokeStyle='#0ff';ctx.lineWidth=1.5;ctx.shadowColor='#0ff';ctx.shadowBlur=8;ctx.beginPath();ctx.moveTo(-13,5);ctx.lineTo(-11,48);ctx.stroke();ctx.beginPath();ctx.moveTo(13,5);ctx.lineTo(11,48);ctx.stroke();ctx.restore();ctx.save();ctx.strokeStyle='#a855f7';ctx.lineWidth=1;ctx.shadowColor='#a855f7';ctx.shadowBlur=5;ctx.beginPath();ctx.moveTo(-8,-15);ctx.lineTo(-12,20);ctx.stroke();ctx.beginPath();ctx.moveTo(8,-15);ctx.lineTo(12,20);ctx.stroke();ctx.restore();ctx.fillStyle='#0a0520';ctx.beginPath();ctx.moveTo(-14,10);ctx.lineTo(-18,20);ctx.lineTo(-16,42);ctx.lineTo(-12,50);ctx.closePath();ctx.fill();ctx.beginPath();ctx.moveTo(14,10);ctx.lineTo(18,20);ctx.lineTo(16,42);ctx.lineTo(12,50);ctx.closePath();ctx.fill();ctx.fillStyle='#0e0e14';ctx.fillRect(-20,-8,7,16);ctx.fillRect(13,-8,7,16);ctx.fillStyle='#15153a';ctx.fillRect(-20,-14,40,4);ctx.save();ctx.fillStyle='#0ff';ctx.shadowColor='#0ff';ctx.shadowBlur=8;ctx.fillRect(-18,-18,36,2);ctx.restore();ctx.fillStyle='#140e30';ctx.beginPath();ctx.moveTo(-4,-34);ctx.lineTo(4,-34);ctx.lineTo(6,-24);ctx.lineTo(-6,-24);ctx.closePath();ctx.fill();ctx.save();ctx.fillStyle='#0ff';ctx.shadowColor='#0ff';ctx.shadowBlur=12;ctx.beginPath();ctx.arc(0,-34,2.5,0,6.28);ctx.fill();ctx.restore();ctx.fillStyle='rgba(0,255,255,.12)';ctx.beginPath();ctx.ellipse(0,18,6,10,0,0,6.28);ctx.fill();ctx.strokeStyle='rgba(0,255,255,.25)';ctx.lineWidth=.8;ctx.stroke();ctx.save();ctx.fillStyle='#a855f7';ctx.shadowColor='#a855f7';ctx.shadowBlur=6;ctx.beginPath();ctx.arc(0,14,4,0,6.28);ctx.fill();ctx.restore();ctx.restore()}
function drawObs(o){ctx.save();ctx.translate(o.x,o.y);if(o.type==='cone'){ctx.save();ctx.fillStyle='#ff6600';ctx.shadowColor='#ff6600';ctx.shadowBlur=10;ctx.beginPath();ctx.moveTo(0,-15);ctx.lineTo(-11,13);ctx.lineTo(11,13);ctx.closePath();ctx.fill();ctx.restore();ctx.fillStyle='rgba(255,255,255,.7)';ctx.beginPath();ctx.moveTo(-4,-2);ctx.lineTo(-7,6);ctx.lineTo(7,6);ctx.lineTo(4,-2);ctx.closePath();ctx.fill();ctx.fillStyle='#ff5500';ctx.fillRect(-13,11,26,5);ctx.save();ctx.strokeStyle='rgba(255,120,0,.4)';ctx.lineWidth=1;ctx.shadowColor='#ff6600';ctx.shadowBlur=5;ctx.beginPath();ctx.moveTo(0,-15);ctx.lineTo(-11,13);ctx.lineTo(11,13);ctx.closePath();ctx.stroke();ctx.restore()}else if(o.type==='rock'){ctx.save();ctx.fillStyle='#3a3a50';ctx.shadowColor='rgba(168,85,247,.25)';ctx.shadowBlur=8;ctx.beginPath();ctx.moveTo(-14,4);ctx.lineTo(-10,-10);ctx.lineTo(-2,-14);ctx.lineTo(8,-12);ctx.lineTo(16,-4);ctx.lineTo(14,8);ctx.lineTo(6,14);ctx.lineTo(-8,12);ctx.closePath();ctx.fill();ctx.restore();ctx.fillStyle='#4a4a60';ctx.beginPath();ctx.moveTo(-8,-2);ctx.lineTo(-4,-10);ctx.lineTo(4,-10);ctx.lineTo(2,-2);ctx.closePath();ctx.fill();ctx.strokeStyle='rgba(168,85,247,.2)';ctx.lineWidth=1;ctx.beginPath();ctx.moveTo(-14,4);ctx.lineTo(-10,-10);ctx.lineTo(-2,-14);ctx.lineTo(8,-12);ctx.lineTo(16,-4);ctx.lineTo(14,8);ctx.lineTo(6,14);ctx.lineTo(-8,12);ctx.closePath();ctx.stroke()}else{const bg=ctx.createLinearGradient(-12,0,12,0);bg.addColorStop(0,'#221540');bg.addColorStop(.3,'#301a58');bg.addColorStop(.7,'#301a58');bg.addColorStop(1,'#221540');ctx.save();ctx.fillStyle=bg;ctx.shadowColor='#a855f7';ctx.shadowBlur=10;ctx.beginPath();ctx.ellipse(0,0,13,16,0,0,6.28);ctx.fill();ctx.restore();ctx.save();ctx.strokeStyle='#0ff';ctx.lineWidth=1.5;ctx.shadowColor='#0ff';ctx.shadowBlur=6;ctx.beginPath();ctx.moveTo(-13,-4);ctx.lineTo(13,-4);ctx.stroke();ctx.beginPath();ctx.moveTo(-13,4);ctx.lineTo(13,4);ctx.stroke();ctx.restore();ctx.fillStyle='#ff00aa';ctx.font='bold 12px Orbitron';ctx.textAlign='center';ctx.fillText('!',0,4)}ctx.restore()}
function collides(a,b){const pad=6;return Math.abs(a.x-b.x)<(a.w/2+b.w/2-pad)&&Math.abs((a.y+a.h/2)-b.y)<(a.h/2+b.h/2-pad)}

// ═══ 메인 루프 (세대 기반) ═══
function loop(gen){
  if(gen!==generation)return;
  frame++;
  if(run){
    const mv=5.5;
    let dx=0,dy=0;
    if(kp['ArrowLeft']||kp['a']||kp['A']) dx=-1;
    if(kp['ArrowRight']||kp['d']||kp['D']) dx=1;
    if(kp['ArrowUp']||kp['w']||kp['W']) dy=-1;
    if(kp['ArrowDown']||kp['s']||kp['S']) dy=1;
    // ★ 대각선 이동 시 √2 보정 (속도 일정)
    if(dx!==0&&dy!==0){dx*=0.7071;dy*=0.7071}
    car.x+=dx*mv; car.y+=dy*mv;
    // ★ X축 범위: 도로 안쪽
    car.x=Math.max(ROAD_L+car.w/2+6,Math.min(ROAD_R-car.w/2-6,car.x));
    // ★ Y축 범위: 상단 116 ~ 하단 714 (전광판 아래 ~ 화면 하단)
    car.y=Math.max(car.h/2+80,Math.min(H-car.h/2-10,car.y));
  }
  if(run){
    const lv=Math.floor(score/20);
    speed=1.5+lv*0.8;     // ★★ 숫자 리터럴 1.5 기반 계산
    if(speed>10)speed=10;
    if(lv>lastLv){lastLv=lv;showLv()}
  }
  if(run&&frame%Math.max(30,70-Math.floor(score/20)*8)===0)spawn();
  for(let i=obstacles.length-1;i>=0;i--){
    obstacles[i].y+=speed*2;
    if(obstacles[i].y>H+60){obstacles.splice(i,1);if(run){score++;document.getElementById('sv').textContent=score;document.getElementById('sp').textContent=Math.floor(60+Math.floor(score/20)*30)}}
  }
  // ★ 무적 타이머 카운트다운
  if(invincible){invTimer--;if(invTimer<=0){invincible=0;invTimer=0}}
  // ★ 충돌 → hit() (생명 시스템)
  if(run&&!invincible)for(const o of obstacles){if(collides(car,o)){hit(o);break}}
  for(let i=particles.length-1;i>=0;i--){const p=particles[i];p.x+=p.vx;p.y+=p.vy;p.life-=.02;if(p.life<=0)particles.splice(i,1)}
  if(run||dead){updBld(bldL,'l');updBld(bldR,'r')}
  ctx.clearRect(0,0,W,H);drawBg();drawRoad();drawScrollBld(bldL);drawScrollBld(bldR);drawMono();
  for(const o of obstacles){ctx.fillStyle='rgba(168,85,247,.03)';ctx.beginPath();ctx.ellipse(o.x+3,o.y+o.h/2+5,o.w/2,5,0,0,6.28);ctx.fill()}
  for(const o of obstacles)drawObs(o);
  if(!dead){
    // ★ 무적 깜빡임: 6프레임 주기로 ON/OFF
    const showCar=!invincible||(frame%6<3);
    if(showCar){
      drawCar(car.x,car.y);
      if(frame%3<2){const fl=Math.random()*8+5;const eg=ctx.createLinearGradient(car.x,car.y+car.h-8,car.x,car.y+car.h+fl);eg.addColorStop(0,'rgba(0,255,255,.6)');eg.addColorStop(.4,'rgba(168,85,247,.35)');eg.addColorStop(1,'transparent');ctx.fillStyle=eg;ctx.beginPath();ctx.moveTo(car.x-3,car.y+car.h-8);ctx.lineTo(car.x+3,car.y+car.h-8);ctx.lineTo(car.x+(Math.random()-.5)*4,car.y+car.h+fl);ctx.closePath();ctx.fill()}
    }
    // ★ 무적 시 보호막 이펙트
    if(invincible){
      ctx.save();ctx.globalAlpha=0.15+Math.sin(frame*0.3)*0.1;
      ctx.strokeStyle='#ff00aa';ctx.lineWidth=2;ctx.shadowColor='#ff00aa';ctx.shadowBlur=15;
      ctx.beginPath();ctx.ellipse(car.x,car.y+car.h/2-8,car.w/2+8,car.h/2+6,0,0,6.28);ctx.stroke();
      ctx.restore();
    }
  }
  for(const p of particles){ctx.save();ctx.globalAlpha=p.life;ctx.fillStyle=p.c;ctx.shadowColor=p.c;ctx.shadowBlur=8;ctx.beginPath();ctx.arc(p.x,p.y,p.r*p.life,0,6.28);ctx.fill();ctx.restore()}
  const vt=ctx.createLinearGradient(0,0,0,40);vt.addColorStop(0,'rgba(3,3,20,.4)');vt.addColorStop(1,'transparent');ctx.fillStyle=vt;ctx.fillRect(0,0,W,40);
  requestAnimationFrame(()=>loop(gen));
}
lbRender('ssLB',null);drawBg();drawRoad();drawScrollBld(bldL);drawScrollBld(bldR);
</script>
</body>
</html>
