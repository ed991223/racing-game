<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1.0,maximum-scale=1.0,user-scalable=no,viewport-fit=cover">
<title>PLAVE Chroma Drift Racing</title>
<!--
  ‚ïî‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïó
  ‚ïë  High-Position UI & Official Streaming Optimized              ‚ïë
  ‚ï†‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ï£
  ‚ïë  [Spotify Web Playback SDK]                                  ‚ïë
  ‚ïë  - PKCE OAuth 2.0 (no backend)                               ‚ïë
  ‚ïë  - Real streaming credit on user account                     ‚ïë
  ‚ïë  - Client ID: b9f605b87a824503b4282fd0ee7dad0f               ‚ïë
  ‚ïë  - Redirect: https://ed991223.github.io/racing-game/         ‚ïë
  ‚ïë  [Dual Media] YouTube muted visual + Spotify audio           ‚ïë
  ‚ïë  [Firebase] initializeFirestore + longPolling + onSnapshot   ‚ïë
  ‚ïë  [Engine] rAF+deltaTime, GPU accel, memory GC, passive evts ‚ïë
  ‚ïë  [Firestore Rules] allow read,create: if true;               ‚ïë
  ‚ïö‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïù
-->
<style>
@import url('https://fonts.googleapis.com/css2?family=Orbitron:wght@400;700;900&family=Rajdhani:wght@500;700&display=swap');
*{margin:0;padding:0;box-sizing:border-box}
html,body{width:100%;height:100%;overflow:hidden}
body{background:#020210;font-family:'Rajdhani',sans-serif}
#wrap{position:relative;width:100vw;height:100vh;height:100dvh;overflow:hidden}
canvas{display:block;width:100%;height:100%;will-change:transform;transform:translate3d(0,0,0)}
#hud{position:absolute;top:max(1.5vh,env(safe-area-inset-top,0px));left:0;right:0;display:flex;justify-content:space-between;padding:0 2vw;pointer-events:none;z-index:2}
.hb{background:rgba(5,5,20,.75);border:1px solid rgba(0,255,255,.25);border-radius:6px;padding:.6vh 1.2vw;color:rgba(0,255,255,.7);font-family:'Orbitron',monospace;font-size:clamp(11px,1.3vw,18px);backdrop-filter:blur(6px);text-shadow:0 0 6px rgba(0,255,255,.3)}
.hb span{color:#0ff;font-weight:700;font-size:clamp(14px,1.8vw,26px)}
.hearts{display:flex;gap:clamp(3px,.4vw,8px);align-items:center}
.ht{font-size:clamp(16px,2vw,28px);transition:all .35s;filter:drop-shadow(0 0 6px rgba(255,0,170,.6))}
.ht.on{color:#ff00aa;text-shadow:0 0 10px rgba(255,0,170,.6)}
.ht.off{color:rgba(60,20,40,.4);filter:none;transform:scale(.8);text-shadow:none}
.ht.pop{animation:htP .5s ease-out forwards}
@keyframes htP{0%{transform:scale(1.5);color:#ff00aa}40%{transform:scale(.6)}100%{transform:scale(.8);color:rgba(60,20,40,.4);filter:none}}
.ov{position:absolute;inset:0;display:flex;flex-direction:column;justify-content:center;align-items:center;background:rgba(3,3,14,.88);z-index:10;backdrop-filter:blur(10px)}
#os{display:none}#ni{display:none;z-index:20}
.tt{font-family:'Orbitron',monospace;font-size:clamp(24px,4vw,52px);font-weight:900;letter-spacing:clamp(3px,.5vw,8px);background:linear-gradient(90deg,#0ff,#a855f7,#0ff);background-size:200% 100%;-webkit-background-clip:text;-webkit-text-fill-color:transparent;animation:sh 3s ease-in-out infinite;filter:drop-shadow(0 0 20px rgba(0,255,255,.4));margin-bottom:4px}
@keyframes sh{0%,100%{background-position:0% 50%}50%{background-position:100% 50%}}
.st{font-size:clamp(11px,1.4vw,18px);color:rgba(168,85,247,.6);margin-bottom:2vh;letter-spacing:clamp(2px,.4vw,5px)}
.bt{font-family:'Orbitron',monospace;font-size:clamp(12px,1.4vw,20px);background:transparent;color:#0ff;border:1px solid rgba(0,255,255,.4);padding:1.2vh 3.5vw;border-radius:6px;cursor:pointer;letter-spacing:3px;transition:all .25s;box-shadow:0 0 20px rgba(0,255,255,.1);text-shadow:0 0 10px rgba(0,255,255,.6);margin-top:1vh}
.bt:hover{background:rgba(0,255,255,.08);border-color:#0ff}
.bt:disabled{opacity:.3;cursor:not-allowed}
.fs{font-family:'Orbitron',monospace;font-size:clamp(36px,5vw,64px);color:#0ff;font-weight:900;margin:.5vh 0;text-shadow:0 0 30px rgba(0,255,255,.5)}
.ky{color:rgba(168,85,247,.35);font-size:clamp(10px,1.1vw,15px);margin-top:1.5vh;letter-spacing:1px}
.lu{position:absolute;top:50%;left:50%;transform:translate(-50%,-50%);font-family:'Orbitron',monospace;font-size:clamp(22px,3.5vw,42px);font-weight:900;color:#0ff;text-shadow:0 0 30px #0ff;pointer-events:none;z-index:5;opacity:0;transition:opacity .3s}
.spz{text-align:center;margin:1vh 0}
.spb{font-family:'Orbitron',monospace;font-size:clamp(11px,1.2vw,16px);background:linear-gradient(135deg,#1db954,#1ed760);color:#000;border:none;padding:1.2vh 3vw;border-radius:30px;cursor:pointer;letter-spacing:2px;font-weight:700;transition:all .25s;box-shadow:0 0 20px rgba(30,215,96,.3);margin:.5vh 0}
.spb:hover{box-shadow:0 0 35px rgba(30,215,96,.5);transform:scale(1.03)}
.spb:disabled{opacity:.4;cursor:not-allowed;transform:none}
.sps{font-family:'Orbitron',monospace;font-size:clamp(9px,1vw,13px);padding:4px 12px;border-radius:4px;display:inline-block;letter-spacing:1px;margin-bottom:.5vh}
.sps.off{background:rgba(255,0,170,.1);border:1px solid rgba(255,0,170,.3);color:#ff8ed4}
.sps.on{background:rgba(30,215,96,.1);border:1px solid rgba(30,215,96,.4);color:#1ed760}
.spsk{font-family:'Orbitron',monospace;font-size:clamp(9px,.9vw,12px);background:transparent;color:rgba(168,85,247,.4);border:1px solid rgba(168,85,247,.15);padding:.5vh 1.5vw;border-radius:4px;cursor:pointer;letter-spacing:1px;margin-top:.3vh;transition:all .2s}
.spsk:hover{color:#a855f7;border-color:rgba(168,85,247,.4)}
.spnow{position:absolute;top:max(6vh,env(safe-area-inset-top,0px));left:1.5vw;z-index:3;background:rgba(5,5,20,.85);border:1px solid rgba(30,215,96,.25);border-radius:8px;padding:6px 12px;display:none;align-items:center;gap:8px;backdrop-filter:blur(8px);max-width:clamp(140px,16vw,240px);will-change:transform;transform:translate3d(0,0,0)}
.spnow .dot{width:8px;height:8px;border-radius:50%;background:#1ed760;box-shadow:0 0 8px rgba(30,215,96,.6);animation:spPl 1.5s ease-in-out infinite;flex-shrink:0}
@keyframes spPl{0%,100%{opacity:.5;transform:scale(.8)}50%{opacity:1;transform:scale(1.2)}}
.spnow .stx{font-size:clamp(9px,.9vw,12px);color:rgba(30,215,96,.7);overflow:hidden;text-overflow:ellipsis;white-space:nowrap}
.lbw{width:clamp(240px,24vw,400px);margin:1.5vh auto .5vh;padding:1.2vh 0 .8vh;background:rgba(5,3,20,.6);border:1px solid rgba(0,255,255,.12);border-radius:6px;max-height:36vh;overflow-y:auto}
.lbt{font-family:'Orbitron',monospace;font-size:clamp(10px,1.1vw,16px);font-weight:700;color:#a855f7;letter-spacing:3px;text-align:center;margin-bottom:1vh}
.lbr{display:flex;align-items:center;padding:.35vh 1.2vw;font-size:clamp(11px,1.1vw,17px)}
.lbr.hl{background:rgba(0,255,255,.06);border-left:2px solid #0ff}
.rk{width:clamp(18px,2vw,30px);font-family:'Orbitron',monospace;font-size:clamp(10px,1vw,15px);font-weight:700;color:#a855f7}
.rk.g{color:#ffd700}.rk.s{color:#c0c0c0}.rk.b{color:#cd7f32}
.nm{flex:1;color:rgba(220,230,255,.75);overflow:hidden;text-overflow:ellipsis;white-space:nowrap;padding:0 .6vw}
.sc{font-family:'Orbitron',monospace;font-size:clamp(11px,1.1vw,17px);font-weight:700;color:#0ff}
.lbe{text-align:center;color:rgba(168,85,247,.3);font-size:clamp(10px,1vw,14px);padding:1vh 0;font-style:italic}
.lbl{text-align:center;color:rgba(0,255,255,.4);font-size:clamp(10px,1vw,14px);padding:1.5vh 0}
.lbl::after{content:'';display:inline-block;width:12px;height:12px;border:2px solid rgba(0,255,255,.3);border-top-color:#0ff;border-radius:50%;animation:lsp .8s linear infinite;margin-left:6px;vertical-align:middle}
@keyframes lsp{to{transform:rotate(360deg)}}
.fba{position:fixed;left:0;right:0;color:#fff;font-family:'Rajdhani',sans-serif;font-size:clamp(12px,1.2vw,16px);padding:1.6vh 2.5vw;text-align:center;z-index:9999;line-height:1.5;display:none}
.fba .cx{position:absolute;right:12px;top:50%;transform:translateY(-50%);font-size:22px;cursor:pointer;opacity:.7}
.fba .cx:hover{opacity:1}
.fba.pm{top:0;background:linear-gradient(135deg,rgba(255,60,0,.95),rgba(200,30,0,.95))}
.fba.ix{top:0;background:rgba(255,0,100,.95)}
.fba strong{display:block;font-family:'Orbitron',monospace;font-size:clamp(12px,1.2vw,16px);margin-bottom:2px}
.fba code{background:rgba(0,0,0,.3);padding:2px 8px;border-radius:3px;font-size:clamp(10px,1vw,13px)}
.nib{background:rgba(8,4,28,.95);border:1px solid rgba(0,255,255,.2);border-radius:8px;padding:3vh 3vw;text-align:center}
.nit{font-family:'Orbitron',monospace;font-size:clamp(14px,1.6vw,22px);font-weight:700;color:#0ff;letter-spacing:2px;margin-bottom:.5vh}
.nis{font-size:clamp(11px,1.2vw,16px);color:rgba(168,85,247,.5);margin-bottom:1.5vh}
.nisc{font-family:'Orbitron',monospace;font-size:clamp(26px,3.5vw,46px);font-weight:900;color:#0ff;margin-bottom:1.5vh}
.nii{width:clamp(150px,16vw,260px);background:rgba(0,0,0,.4);border:1px solid rgba(0,255,255,.2);border-radius:4px;padding:1vh 1.2vw;color:#0ff;font-family:'Orbitron',monospace;font-size:clamp(12px,1.3vw,18px);text-align:center;letter-spacing:2px;outline:none}
.nii:focus{border-color:rgba(0,255,255,.5)}
.nii::placeholder{color:rgba(0,255,255,.2)}
.nbt{font-family:'Orbitron',monospace;font-size:clamp(10px,1.1vw,15px);background:rgba(0,255,255,.08);color:#0ff;border:1px solid rgba(0,255,255,.3);padding:1vh 2.5vw;border-radius:4px;cursor:pointer;letter-spacing:2px;margin-top:1.5vh;transition:all .2s}
.nbt:hover{background:rgba(0,255,255,.15)}
.nsv{pointer-events:none;opacity:.5}
.bb{position:absolute;top:2vh;right:1.5vw;width:clamp(140px,13vw,260px);z-index:1;pointer-events:none}
.bbf{position:relative;width:100%;padding-bottom:56.25%;background:#0a0a1c;border:2px solid #2e2e48;border-radius:3px;box-shadow:0 0 14px rgba(0,255,255,.1),inset 0 0 18px rgba(0,0,0,.9);overflow:hidden}
.bbf::after{content:'';position:absolute;inset:-4px;border-radius:5px;pointer-events:none;z-index:4;border:2px solid transparent;animation:bfl 2.2s ease-in-out infinite}
@keyframes bfl{0%,100%{border-color:rgba(255,0,170,.7);box-shadow:0 0 8px rgba(255,0,170,.3)}50%{border-color:rgba(0,255,255,.9);box-shadow:0 0 12px rgba(0,255,255,.45)}80%{border-color:rgba(255,0,170,.05);box-shadow:none}}
.bnt{position:absolute;top:-2px;left:5%;right:5%;height:2px;background:#ff00aa;z-index:6;box-shadow:0 0 8px #ff00aa;animation:bn1 1.5s ease-in-out infinite}
@keyframes bn1{0%,100%{opacity:.6}50%{opacity:1}}
.bnb{position:absolute;bottom:-2px;left:5%;right:5%;height:2px;background:#0ff;z-index:6;box-shadow:0 0 8px #0ff;animation:bn2 1.8s ease-in-out infinite}
@keyframes bn2{0%,100%{opacity:.5}50%{opacity:1}}
.bbs{position:absolute;inset:0;overflow:hidden;background:#000}
.bbs iframe{width:100%!important;height:100%!important;border:none;pointer-events:none}
.bbl{position:absolute;bottom:0;left:0;right:0;height:16%;display:flex;align-items:center;justify-content:center;background:linear-gradient(180deg,transparent,rgba(8,4,24,.95));z-index:3}
.bbl span{font-family:'Orbitron',monospace;font-size:clamp(5px,.55vw,8px);font-weight:700;color:#ff00aa;letter-spacing:2px;animation:btg 2s ease-in-out infinite}
@keyframes btg{0%,100%{color:#ff00aa}50%{color:#0ff}}
.tz{display:none;position:absolute;right:40px;bottom:180px;bottom:calc(180px + env(safe-area-inset-bottom,0px));z-index:4;pointer-events:auto;opacity:.7;will-change:transform;transform:translate3d(0,0,0);touch-action:none}
.tz .dp{position:relative;width:clamp(150px,32vw,220px);height:clamp(150px,32vw,220px)}
.tz .db{position:absolute;background:rgba(0,255,255,.08);border:1.5px solid rgba(0,255,255,.35);border-radius:10px;display:flex;align-items:center;justify-content:center;color:rgba(0,255,255,.7);font-size:clamp(20px,4.5vw,30px);user-select:none;-webkit-user-select:none;touch-action:none;min-width:48px;min-height:48px;-webkit-tap-highlight-color:transparent}
.tz .db:active,.tz .db.p{background:rgba(0,255,255,.35);border-color:#0ff}
.tz .db.u{top:0;left:30%;width:40%;height:32%}
.tz .db.d{bottom:0;left:30%;width:40%;height:32%}
.tz .db.l{top:34%;left:0;width:32%;height:32%}
.tz .db.r{top:34%;right:0;width:32%;height:32%}
</style>
</head>
<body>
<div class="fba pm" id="pmA"><strong>üîí Îç∞Ïù¥ÌÑ∞Î≤†Ïù¥Ïä§ Í∂åÌïú ÏÑ§Ï†ï ÌïÑÏöî</strong>Firebase Console ‚Üí Firestore ‚Üí Rules<br><code>allow read, create: if true;</code><span class="cx" id="pmX">‚úï</span></div>
<div class="fba ix" id="ixA"><strong>‚ö†Ô∏è Firestore ÏÉâÏù∏ ÌïÑÏöî</strong>ÏΩòÏÜî(F12)Ïùò ÎßÅÌÅ¨Î•º ÌÅ¥Î¶≠ÌïòÏó¨ ÏÉâÏù∏ ÏÉùÏÑ±<span class="cx" id="ixX">‚úï</span></div>
<div id="wrap">
<canvas id="c"></canvas>
<div id="hud"><div class="hb"><div class="hearts"><span class="ht on" id="h0">‚ô•</span><span class="ht on" id="h1">‚ô•</span><span class="ht on" id="h2">‚ô•</span></div></div><div class="hb">SCORE <span id="sv">0</span></div><div class="hb">SPEED <span id="spd">60</span>km</div></div>
<div class="lu" id="lu">SPEED UP!</div>
<div class="spnow" id="spN"><div class="dot"></div><div class="stx" id="spT">‚ô´ Streaming...</div></div>
<div class="bb"><div class="bbf"><div class="bnt"></div><div class="bnb"></div><div class="bbs"><div id="ytF"></div></div><div class="bbl"><span>‚òÖ PLAVE ‚òÖ</span></div></div></div>
<div class="tz" id="tPad"><div class="dp"><div class="db u" data-dir="up">‚ñ≤</div><div class="db d" data-dir="down">‚ñº</div><div class="db l" data-dir="left">‚óÄ</div><div class="db r" data-dir="right">‚ñ∂</div></div></div>
<div class="ov" id="ss">
  <div class="tt">PLAVE CHROMA DRIFT</div>
  <div class="st">C Y B E R P U N K &nbsp; R A C E R</div>
  <div class="spz" id="spZ">
    <div class="sps off" id="spS">‚óè SPOTIFY ÎØ∏Ïó∞Í≤∞</div><br>
    <button class="spb" id="spL">üéµ Spotify Premium Î°úÍ∑∏Ïù∏</button><br>
    <button class="spsk" id="spK">Spotify ÏóÜÏù¥ ÌîåÎ†àÏù¥</button>
  </div>
  <div id="ssLB"></div>
  <button class="bt" id="sb" disabled>SPOTIFY Î°úÍ∑∏Ïù∏ ÌõÑ ÏãúÏûë</button>
  <div class="ky" id="cH">‚Üë‚Üì‚Üê‚Üí ÎòêÎäî WASD</div>
</div>
<div class="ov" id="os">
  <div class="tt" style="font-size:clamp(24px,3.5vw,44px)">WASTED</div>
  <div class="st">FINAL SCORE</div>
  <div class="fs" id="fsc">0</div>
  <div id="osLB"></div>
  <button class="bt" id="rb">RETRY</button>
  <div class="ky">RÌÇ§ Ï¶âÏãú Ïû¨ÏãúÏûë</div>
</div>
<div class="ov" id="ni">
  <div class="nib">
    <div class="nit">‚òÖ WORLD RANKING ‚òÖ</div>
    <div class="nis">Ï†Ñ ÏÑ∏Í≥Ñ Îû≠ÌÇπÏóê Ïù¥Î¶ÑÏùÑ ÎÇ®Í∏∞ÏÑ∏Ïöî!</div>
    <div class="nisc" id="nSc">0</div>
    <input class="nii" id="nIn" type="text" maxlength="8" placeholder="NICKNAME" autocomplete="off"><br>
    <button class="nbt" id="nBt">SAVE</button>
  </div>
</div>
</div>
<script src="https://sdk.scdn.co/spotify-player.js"></script>
<script>
var ytP=null,ytOk=false,ytRe=0;
var ytS=document.createElement('script');ytS.src='https://www.youtube.com/iframe_api';document.head.appendChild(ytS);
function onYouTubeIframeAPIReady(){mkYT()}
function mkYT(){
  var s=document.querySelector('.bbs');if(!s)return;
  ytP=new YT.Player('ytF',{
    width:String(s.clientWidth||200),height:String(s.clientHeight||120),videoId:'b3GoZMfHJT4',
    host:'https://www.youtube-nocookie.com',
    playerVars:{autoplay:1,mute:1,loop:1,playlist:'b3GoZMfHJT4',controls:0,disablekb:1,fs:0,rel:0,playsinline:1,modestbranding:1,showinfo:0,origin:location.origin,enablejsapi:1},
    events:{
      onReady:function(e){ytOk=true;ytRe=0;e.target.mute();e.target.playVideo()},
      onStateChange:function(e){if(e.data===YT.PlayerState.ENDED){e.target.seekTo(0);e.target.playVideo()}},
      onError:function(){if(ytRe<3){ytRe++;setTimeout(function(){try{if(ytP&&ytP.destroy)ytP.destroy()}catch(x){}ytOk=false;var c=document.querySelector('.bbs');if(c&&!document.getElementById('ytF')){var d=document.createElement('div');d.id='ytF';c.appendChild(d)}mkYT()},1500*ytRe)}}
    }
  })
}
</script>
<script type="module">
import{initializeApp}from"https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
import{initializeFirestore,collection,addDoc,query,orderBy,limit,onSnapshot,serverTimestamp}from"https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

const SP_ID='b9f605b87a824503b4282fd0ee7dad0f';
const SP_RD='https://ed991223.github.io/racing-game/';
const SP_SC='streaming user-read-email user-read-private user-modify-playback-state';
const SP_URI='spotify:track:4JMhRqgiJmRjziBIWsCVqn';
let spTk=null,spPl=null,spDev=null,spOk=false,spOn=false;

function b64u(buf){return btoa(String.fromCharCode(...new Uint8Array(buf))).replace(/\+/g,'-').replace(/\//g,'_').replace(/=+$/,'')}
async function pkce(){const v=b64u(crypto.getRandomValues(new Uint8Array(64)));sessionStorage.setItem('sp_v',v);const d=await crypto.subtle.digest('SHA-256',new TextEncoder().encode(v));return{v,c:b64u(d)}}
async function spLogin(){const{c}=await pkce();location.href='https://accounts.spotify.com/authorize?'+new URLSearchParams({client_id:SP_ID,response_type:'code',redirect_uri:SP_RD,scope:SP_SC,code_challenge_method:'S256',code_challenge:c})}
async function spExch(code){const v=sessionStorage.getItem('sp_v');if(!v)return null;const r=await fetch('https://accounts.spotify.com/api/token',{method:'POST',headers:{'Content-Type':'application/x-www-form-urlencoded'},body:new URLSearchParams({client_id:SP_ID,grant_type:'authorization_code',code,redirect_uri:SP_RD,code_verifier:v})});if(!r.ok)return null;const d=await r.json();sessionStorage.removeItem('sp_v');return d.access_token}
function spErr(msg){$('spS').className='sps off';$('spS').textContent='‚úï '+msg;console.error('[Spotify]',msg)}
async function transferPlayback(play){
  if(!spDev||!spTk)return false;
  try{
    const r=await fetch('https://api.spotify.com/v1/me/player',{method:'PUT',headers:{Authorization:'Bearer '+spTk,'Content-Type':'application/json'},body:JSON.stringify({device_ids:[spDev],play:!!play})});
    if(r.status===403){spErr('ÌîÑÎ¶¨ÎØ∏ÏóÑ Í≥ÑÏ†ï Ïó¨Î∂ÄÎ•º ÌôïÏù∏ÌïòÏÑ∏Ïöî');return false}
    if(r.status===401){spErr('ÌÜ†ÌÅ∞ ÎßåÎ£å ‚Äî Îã§Ïãú Î°úÍ∑∏Ïù∏Ìï¥Ï£ºÏÑ∏Ïöî');return false}
    if(!r.ok&&r.status!==204){spErr('Í∏∞Í∏∞ Ï†ÑÌôò Ïã§Ìå® ('+r.status+')');return false}
    console.log('[Spotify] ‚úÖ Transfer OK (play='+play+')');return true;
  }catch(e){spErr('Ïä§Ìè¨Ìã∞ÌååÏù¥ Ïó∞Í≤∞ Ïã§Ìå®: Îã§Ïãú Î°úÍ∑∏Ïù∏Ìï¥Ï£ºÏÑ∏Ïöî');return false}
}
function spInit(tk){
  if(!window.Spotify)return;
  spPl=new Spotify.Player({name:'PLAVE Racing',getOAuthToken:cb=>cb(tk),volume:.8});
  spPl.addListener('ready',async({device_id})=>{
    spDev=device_id;spOk=true;
    console.log('[Spotify] ‚úÖ SDK Ready, device:',device_id);
    const ok=await transferPlayback(false);
    if(ok){$('spS').className='sps on';$('spS').textContent='‚óè SPOTIFY Ïó∞Í≤∞Îê® (Premium)';unlock()}
  });
  spPl.addListener('not_ready',()=>{spOk=false;spErr('Í∏∞Í∏∞ Ïò§ÌîÑÎùºÏù∏ ‚Äî ÏÉàÎ°úÍ≥†Ïπ®ÌïòÏÑ∏Ïöî')});
  spPl.addListener('player_state_changed',st=>{if(!st)return;const t=st.track_window.current_track;if(t){$('spT').textContent='‚ô´ '+t.name+' ‚Äî '+t.artists[0].name;$('spN').style.display='flex'}});
  spPl.addListener('initialization_error',({message:m})=>spErr('SDK Ï¥àÍ∏∞Ìôî Ïã§Ìå®'));
  spPl.addListener('authentication_error',({message:m})=>spErr('Ïù∏Ï¶ù Ïã§Ìå® ‚Äî Îã§Ïãú Î°úÍ∑∏Ïù∏Ìï¥Ï£ºÏÑ∏Ïöî'));
  spPl.addListener('account_error',({message:m})=>spErr('Premium Í≥ÑÏ†ïÏù¥ ÌïÑÏöîÌï©ÎãàÎã§'));
  spPl.connect().then(ok=>{if(!ok)spErr('SDK Ïó∞Í≤∞ Ïã§Ìå®')});
}
async function spPlay(){
  if(!spOk||!spDev||!spTk)return;
  try{
    if(spPl&&spPl.activateElement)await spPl.activateElement();
    const tok=await transferPlayback(true);
    if(!tok)return;
    const r=await fetch('https://api.spotify.com/v1/me/player/play?device_id='+spDev,{method:'PUT',headers:{Authorization:'Bearer '+spTk,'Content-Type':'application/json'},body:JSON.stringify({uris:[SP_URI]})});
    if(r.ok||r.status===204){spOn=true;console.log('[Spotify] ‚ñ∂ Playing')}
    else if(r.status===403)spErr('ÌîÑÎ¶¨ÎØ∏ÏóÑ Í≥ÑÏ†ï Ïó¨Î∂ÄÎ•º ÌôïÏù∏ÌïòÏÑ∏Ïöî');
    else if(r.status===401)spErr('ÌÜ†ÌÅ∞ ÎßåÎ£å ‚Äî Îã§Ïãú Î°úÍ∑∏Ïù∏Ìï¥Ï£ºÏÑ∏Ïöî');
    else spErr('Ïû¨ÏÉù Ïã§Ìå® ('+r.status+')');
  }catch(e){spErr('Ïä§Ìè¨Ìã∞ÌååÏù¥ Ïó∞Í≤∞ Ïã§Ìå®: Îã§Ïãú Î°úÍ∑∏Ïù∏Ìï¥Ï£ºÏÑ∏Ïöî')}
}
async function spPause(){if(spPl)try{await spPl.pause()}catch(e){}}
async function spResume(){
  if(!spPl)return;
  try{if(spPl.activateElement)await spPl.activateElement();await spPl.resume()}catch(e){}
}
window.onSpotifyWebPlaybackSDKReady=()=>{if(spTk)spInit(spTk)};
(async()=>{const p=new URLSearchParams(location.search);const code=p.get('code');if(code){history.replaceState({},'',location.pathname);const tk=await spExch(code);if(tk){spTk=tk;if(window.Spotify)spInit(tk)}}})();

let gameOk=false;
function unlock(){gameOk=true;const b=$('sb');b.disabled=false;b.textContent='START'}
function $(id){return document.getElementById(id)}

$('spL').onclick=()=>spLogin();
$('spK').onclick=()=>{$('spS').className='sps off';$('spS').textContent='‚óè Ïò§ÌîÑÎùºÏù∏ Î™®Îìú';unlock()};
$('pmX').onclick=()=>$('pmA').style.display='none';
$('ixX').onclick=()=>$('ixA').style.display='none';

let db=null,fbOk=false;
try{const app=initializeApp({apiKey:"AIzaSyDsPGWA-KvoS3Yg5MXMMziFvaZ3F7f2I88",authDomain:"racing-game-28130.firebaseapp.com",projectId:"racing-game-28130",storageBucket:"racing-game-28130.firebasestorage.app",messagingSenderId:"200881814519",appId:"1:200881814519:web:4ef37fc6f4c6c5c1baccf2"});
db=initializeFirestore(app,{experimentalForceLongPolling:true});fbOk=true;console.log('[Firebase] ‚úÖ OK')}catch(e){console.error('[Firebase]',e)}

let pmSh=false,ixSh=false;
function fbErr(e){const m=e&&e.message?e.message:'',c=e&&e.code?e.code:'';if((m.includes('permission')||c==='permission-denied')&&!pmSh){pmSh=true;$('pmA').style.display='block'}if((m.includes('index')||m.includes('Index'))&&!ixSh){ixSh=true;$('ixA').style.display='block'}}
async function fbSave(nk,sc){if(!fbOk||!db)return;await addDoc(collection(db,'leaderboard'),{nickname:nk,score:sc,timestamp:serverTimestamp()})}
let liveLB=[];
function startRT(){if(!fbOk||!db)return;try{const q=query(collection(db,'leaderboard'),orderBy('score','desc'),limit(10));onSnapshot(q,sn=>{liveLB=[];sn.forEach(d=>{const x=d.data();liveLB.push({n:x.nickname||'???',s:x.score||0})});rLB()},e=>{console.warn('[onSnapshot]',e);fbErr(e)})}catch(e){fbErr(e)}}

let hlSc=null;
function esc(s){return String(s).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;')}
function lbH(d){if(!d||!d.length)return'<div class="lbw"><div class="lbt">üåê WORLD RANKING</div><div class="lbe">No records</div></div>';let h='<div class="lbw"><div class="lbt">üåê WORLD RANKING</div>';for(let i=0;i<d.length;i++){const e=d[i],rc=i<1?'g':i<2?'s':i<3?'b':'',hl=hlSc!=null&&e.s===hlSc;h+='<div class="lbr'+(hl?' hl':'')+'"><div class="rk '+rc+'">'+(i+1)+'</div><div class="nm">'+esc(e.n)+'</div><div class="sc">'+e.s+'</div></div>'}return h+'</div>'}
function rLB(){const h=lbH(liveLB);$('ssLB').innerHTML=h;$('osLB').innerHTML=h}

const cv=$('c'),cx=cv.getContext('2d');
const isM=(()=>{if('ontouchstart'in window||navigator.maxTouchPoints>0)return true;return/Android|iPhone|iPad|iPod/i.test(navigator.userAgent)||innerWidth<=900})();
window.Q=isM?0:1;const Q=window.Q;
const MXP=Q?150:40,WD=Q?1:0,ND=Q?1:0,SL=Q?5:2,GD=Q?1:0,PG=Q?1:0;
if(isM){$('tPad').style.display='block';$('cH').textContent='D-Pad Ï°∞Ïûë';
(()=>{const t=$('tPad');function rc(){const vh=window.visualViewport?window.visualViewport.height:innerHeight;t.style.bottom=Math.max(180,Math.round(vh*.25))+'px'}rc();if(window.visualViewport)window.visualViewport.addEventListener('resize',rc,{passive:true});addEventListener('resize',rc,{passive:true})})()}

let W,H,S,RL,RR,RW,LW;
function calc(){W=window.visualViewport?Math.round(window.visualViewport.width):innerWidth;H=window.visualViewport?Math.round(window.visualViewport.height):innerHeight;cv.width=W;cv.height=H;S=H/760;RL=Math.round(W*.175);RR=Math.round(W*.825);RW=RR-RL;LW=RW/4;const w=$('wrap');if(w){w.style.width=W+'px';w.style.height=H+'px'}}
calc();

let gen=0,run=0,dead=0,score=0,speed=1.5,frm=0,lastLv=0,rOff=0,gOff=0;
const kp={};const car={x:0,y:0,w:0,h:0};
function initC(){car.w=Math.round(38*S);car.h=Math.round(72*S)}
initC();car.x=W/2;car.y=H-Math.round(110*S);
let obs=[],ptc=[],pSc=null;
const ML=3;let lives=3,isInv=false,invT=0;const INV=90;let hitLk=false;
let lt=0;const TF=60,TD=1000/TF;let dt=1,spAcc=0;

function gDif(){const l=Math.floor(score/15);return{l,sp:Math.min(10,1.5+Math.log2(l+1)*1.6),iv:Math.max(400,1200-l*80),mc:l<5?0:Math.min(.5,(l-5)*.04+.1),tc:l>=8?Math.min(.1,(l-8)*.015):0}}
function onRs(){const oW=W,oH=H;calc();initC();if(oW>0&&oH>0){car.x*=W/oW;car.y*=H/oH}initBld()}
addEventListener('resize',onRs,{passive:true});
if(window.visualViewport)window.visualViewport.addEventListener('resize',onRs,{passive:true});

let bL=[],bR=[];
function mkB(s){const w=Math.round((18+Math.random()*28)*S),h=Math.round((35+Math.random()*65)*S);const x=s==='l'?Math.random()*Math.max(10,RL-w-4):RR+4+Math.random()*Math.max(10,W-RR-w-4);const ns=[];for(let i=0,nc=Q?(1+~~(Math.random()*3)):1;i<nc;i++)ns.push({ry:.15+Math.random()*.55,rw:.25+Math.random()*.5,c:['#0ff','#a855f7','#ff00aa','#00ff88','#0af'][~~(Math.random()*5)],b:Math.random()*6.28,sp:.008+Math.random()*.025});return{x,y:-h,w,h,ns,wr:Math.max(1,~~(h/(11*S))),wc:Math.max(1,~~(w/(8*S))),wn:Q?Math.random()>.25:Math.random()>.6,bc:'rgb('+~~(5+Math.random()*10)+','+~~(5+Math.random()*8)+','+~~(15+Math.random()*15)+')'}}
function initBld(){bL=[];bR=[];const g=Math.round(80*S);let ly=-g;while(ly<H+g){const b=mkB('l');b.y=ly;bL.push(b);ly+=b.h+Math.round((3+Math.random()*8)*S)}let ry=-g;while(ry<H+g){const b=mkB('r');b.y=ry;bR.push(b);ry+=b.h+Math.round((3+Math.random()*8)*S)}}
initBld();let mono={x:-Math.round(220*S),y:0,sp:.6,on:0,t:0};

function updH(){for(let i=0;i<ML;i++){const e=$('h'+i);if(e)e.className=i<lives?'ht on':'ht off'}}
function lsH(i){const e=$('h'+i);if(e)e.className='ht pop'}
function hitO(oi){
  if(isInv||hitLk||lives<=0)return;hitLk=true;lives--;lsH(lives);
  if(oi>=0&&oi<obs.length)obs.splice(oi,1);
  for(let i=0,pc=Q?15:8;i<pc;i++)ptc.push({x:car.x,y:car.y+car.h/2,vx:(Math.random()-.5)*8*S,vy:(Math.random()-.5)*8*S,r:(1.5+Math.random()*3)*S,lf:.7,c:['#ff00aa','#a855f7','#fff'][~~(Math.random()*3)]});
  if(lives<=0){hitLk=false;die()}else{isInv=true;invT=INV;car.y=Math.min(car.y+Math.round(60*S),H-car.h/2-10);hitLk=false}
}
function die(){
  dead=1;run=0;isInv=false;hitLk=false;const fs=score;
  for(let i=0,pc=Q?40:20;i<pc;i++)ptc.push({x:car.x,y:car.y+car.h/2,vx:(Math.random()-.5)*10*S,vy:(Math.random()-.5)*10*S,r:(2+Math.random()*5)*S,lf:1,c:['#0ff','#a855f7','#ff00aa','#fff','#00ff88'][~~(Math.random()*5)]});
  setTimeout(()=>{if(fs>0)showNI(fs);else showGO(fs)},900);
}

document.addEventListener('keydown',e=>{if($('ni').style.display==='flex'){if(e.key==='Enter')subN();return}kp[e.key]=1;if((e.key==='r'||e.key==='R')&&dead)restart();if((e.key===' '||e.key==='Enter')&&!run&&!dead&&gameOk)startG()});
document.addEventListener('keyup',e=>{kp[e.key]=0});
$('sb').onclick=()=>{if(gameOk)startG()};
$('rb').onclick=()=>restart();
$('nBt').onclick=()=>subN();

let tX=null,tY=null;
cv.addEventListener('touchstart',e=>{e.preventDefault();tX=e.touches[0].clientX;tY=e.touches[0].clientY},{passive:false});
cv.addEventListener('touchmove',e=>{e.preventDefault();if(tX!==null){const dx=e.touches[0].clientX-tX,dy=e.touches[0].clientY-tY;if(Math.abs(dx)>8){car.x+=dx>0?5*S:-5*S;tX=e.touches[0].clientX}if(Math.abs(dy)>8){car.y+=dy>0?5*S:-5*S;tY=e.touches[0].clientY}}},{passive:false});
cv.addEventListener('touchend',()=>{tX=null;tY=null},{passive:true});

const dp={up:0,down:0,left:0,right:0};
document.querySelectorAll('.db').forEach(b=>{const d=b.dataset.dir;
  b.addEventListener('touchstart',e=>{e.preventDefault();e.stopPropagation();dp[d]=1;b.classList.add('p')},{passive:false});
  b.addEventListener('touchend',e=>{e.preventDefault();e.stopPropagation();dp[d]=0;b.classList.remove('p')},{passive:false});
  b.addEventListener('touchcancel',()=>{dp[d]=0;b.classList.remove('p')},{passive:true});
  b.addEventListener('touchmove',e=>{const t=e.touches[0],r=b.getBoundingClientRect();if(t.clientX<r.left||t.clientX>r.right||t.clientY<r.top||t.clientY>r.bottom){dp[d]=0;b.classList.remove('p')}},{passive:true})});

function showNI(sc){pSc=sc;$('nSc').textContent=sc;$('nIn').value='';$('nBt').classList.remove('nsv');$('nBt').textContent='SAVE';$('ni').style.display='flex';setTimeout(()=>$('nIn').focus(),100)}
async function subN(){let nk=$('nIn').value.trim();if(!nk)nk='RACER';if(nk.length>8)nk=nk.slice(0,8);const bt=$('nBt');bt.classList.add('nsv');bt.textContent='SAVING...';
try{await fbSave(nk,pSc)}catch(e){console.warn('[Save]',e);fbErr(e)}
$('ni').style.display='none';bt.classList.remove('nsv');bt.textContent='SAVE';hlSc=pSc;showGO(pSc);pSc=null}
function showGO(sc){$('fsc').textContent=sc;rLB();$('os').style.display='flex'}

function spawn(){const ts=['cone','rock','barrel'],t=ts[~~(Math.random()*3)],mg=Math.round(18*S),cx=RL+mg+Math.random()*(RW-mg*2);let w,h;if(t==='cone'){w=Math.round(24*S);h=Math.round(30*S)}else if(t==='rock'){w=Math.round(36*S);h=Math.round(28*S)}else{w=Math.round(28*S);h=Math.round(32*S)}obs.push({t,x:cx,y:-Math.round(50*S),w,h})}
function spawnM(n){const ts=['cone','rock','barrel'],used=[];for(let i=0;i<n;i++){let ln,tr=0;do{ln=~~(Math.random()*4);tr++}while(used.includes(ln)&&tr<8);used.push(ln);const t=ts[~~(Math.random()*3)],cx=RL+LW*ln+LW/2;let w,h;if(t==='cone'){w=Math.round(24*S);h=Math.round(30*S)}else if(t==='rock'){w=Math.round(36*S);h=Math.round(28*S)}else{w=Math.round(28*S);h=Math.round(32*S)}obs.push({t,x:cx,y:-Math.round((50+i*30)*S),w,h})}}
function showLv(){const e=$('lu');e.style.opacity='1';setTimeout(()=>e.style.opacity='0',1200)}

function resetAll(){gen++;run=1;dead=0;score=0;speed=1.5;frm=0;lastLv=0;rOff=0;gOff=0;spAcc=0;lt=0;calc();initC();car.x=W/2;car.y=H-Math.round(110*S);obs=[];ptc=[];lives=3;isInv=false;invT=0;hitLk=false;for(const k in kp)kp[k]=0;dp.up=0;dp.down=0;dp.left=0;dp.right=0;initBld();mono={x:-Math.round(220*S),y:0,sp:.6*S,on:0,t:0};$('sv').textContent='0';$('spd').textContent='60';updH()}
function startG(){$('ss').style.display='none';$('ni').style.display='none';resetAll();if(spOk&&spTk){if(spPl&&spPl.activateElement)spPl.activateElement();spPlay()}lt=performance.now();requestAnimationFrame(t=>loop(gen,t))}
function restart(){$('os').style.display='none';$('ni').style.display='none';resetAll();if(spOk&&spOn){if(spPl&&spPl.activateElement)spPl.activateElement();spResume()}lt=performance.now();requestAnimationFrame(t=>loop(gen,t))}

function dBg(){cx.fillStyle='#04041a';cx.fillRect(0,0,W,H)}
function dBld(a){for(let i=0;i<a.length;i++){const b=a[i];if(b.y+b.h<-10||b.y>H+10)continue;const bg=cx.createLinearGradient(b.x,b.y,b.x+b.w,b.y+b.h);bg.addColorStop(0,b.bc);bg.addColorStop(1,'#040412');cx.fillStyle=bg;cx.fillRect(b.x,b.y,b.w,b.h);cx.strokeStyle='rgba(0,255,255,.04)';cx.lineWidth=.5;cx.strokeRect(b.x,b.y,b.w,b.h);if(b.wn){const ww=4*S,wh=5*S,gX=Math.max(6*S,(b.w-4*S)/b.wc),gY=Math.max(8*S,(b.h-6*S)/b.wr);if(WD){for(let r=0;r<b.wr;r++)for(let c=0;c<b.wc;c++){const wx=b.x+3*S+c*gX,wy=b.y+4*S+r*gY;if(wy<b.y||wy+wh>b.y+b.h)continue;if(Math.sin(wx*5.3+wy*3.7+frm*.001)>.1){cx.fillStyle='rgba(0,255,255,'+(.03+Math.sin(wx*.3+wy*.2+frm*.004)*.02)+')';cx.fillRect(wx,wy,ww,wh)}}}else{cx.fillStyle='rgba(0,255,255,.035)';for(let r=0;r<b.wr;r+=2)for(let c=0;c<b.wc;c+=2){const wx=b.x+3*S+c*gX,wy=b.y+4*S+r*gY;if(wy>=b.y&&wy+wh<=b.y+b.h)cx.fillRect(wx,wy,ww,wh)}}}for(let ni=0;ni<b.ns.length;ni++){const n=b.ns[ni];n.b+=n.sp;const na=.4+Math.sin(n.b)*.4,ny=b.y+b.h*n.ry,nw=b.w*n.rw,nx=b.x+(b.w-nw)/2;if(ny<b.y||ny>b.y+b.h)continue;cx.save();cx.globalAlpha=na*.8;if(ND){cx.shadowColor=n.c;cx.shadowBlur=14*S}cx.fillStyle=n.c;cx.fillRect(nx,ny,nw,2.5*S);cx.restore()}}}
function uBld(a,sd){const s=speed*2*S*dt;for(let i=0;i<a.length;i++)a[i].y+=s;for(let i=a.length-1;i>=0;i--){if(a[i].y>H+10){a.splice(i,1);const nb=mkB(sd);let ty=H;for(let j=0;j<a.length;j++)if(a[j].y<ty)ty=a[j].y;nb.y=ty-nb.h-Math.round((3+Math.random()*8)*S);a.push(nb)}}}
function dRoad(){const rg=cx.createLinearGradient(RL,0,RR,0);rg.addColorStop(0,'#0d0d18');rg.addColorStop(.03,'#111120');rg.addColorStop(.97,'#111120');rg.addColorStop(1,'#0d0d18');cx.fillStyle=rg;cx.fillRect(RL,0,RW,H);if(GD){const gs=Math.round(28*S);gOff=(gOff+speed*1.8*S*dt)%gs;cx.strokeStyle='rgba(0,255,255,.02)';cx.lineWidth=.5;for(let gy=-gs+gOff;gy<H;gy+=gs){cx.beginPath();cx.moveTo(RL+2,gy);cx.lineTo(RR-2,gy);cx.stroke()}for(let gx=RL+gs/2;gx<RR;gx+=gs){cx.beginPath();cx.moveTo(gx,0);cx.lineTo(gx,H);cx.stroke()}}rOff+=speed*2.5*S*dt;cx.save();cx.strokeStyle='#0ff';cx.lineWidth=2.5*S;if(Q){cx.shadowColor='#0ff';cx.shadowBlur=18*S}cx.beginPath();cx.moveTo(RL,0);cx.lineTo(RL,H);cx.stroke();cx.beginPath();cx.moveTo(RR,0);cx.lineTo(RR,H);cx.stroke();cx.restore();const eg=Math.round(30*S);let r1=cx.createLinearGradient(RL,0,RL+eg,0);r1.addColorStop(0,'rgba(0,255,255,.04)');r1.addColorStop(1,'transparent');cx.fillStyle=r1;cx.fillRect(RL,0,eg,H);let r2=cx.createLinearGradient(RR,0,RR-eg,0);r2.addColorStop(0,'rgba(0,255,255,.04)');r2.addColorStop(1,'transparent');cx.fillStyle=r2;cx.fillRect(RR-eg,0,eg,H);cx.save();cx.setLineDash([26*S,20*S]);cx.lineDashOffset=-rOff;cx.strokeStyle='rgba(168,85,247,.3)';cx.lineWidth=1.5*S;if(Q){cx.shadowColor='#a855f7';cx.shadowBlur=5*S}for(let i=1;i<4;i++){const lx=RL+LW*i;cx.beginPath();cx.moveTo(lx,0);cx.lineTo(lx,H);cx.stroke()}cx.restore();if(speed>2){const la=Math.min((speed-2)*.03,.12);cx.strokeStyle='rgba(0,255,255,'+la+')';cx.lineWidth=.8*S;for(let i=0;i<SL;i++){const sx=RL+15*S+Math.random()*(RW-30*S),sy=Math.random()*H;cx.beginPath();cx.moveTo(sx,sy);cx.lineTo(sx,sy+(15+speed*7)*S);cx.stroke()}}}
function dMono(){mono.t+=dt;const mW=Math.round(200*S),mH=Math.round(22*S);if(!mono.on&&mono.t>350){mono.on=1;mono.x=-Math.round(240*S);mono.t=0;mono.y=Math.round((25+Math.random()*40)*S);mono.sp=(.5+Math.random()*.4)*S}if(!mono.on)return;mono.x+=mono.sp*dt;if(mono.x>W+mW+60){mono.on=0;mono.t=0;return}const mx=mono.x,my=mono.y;cx.strokeStyle='rgba(168,85,247,.15)';cx.lineWidth=1.5*S;cx.beginPath();cx.moveTo(0,my+mH+2);cx.lineTo(W,my+mH+2);cx.stroke();const tg=cx.createLinearGradient(mx,my,mx,my+mH);tg.addColorStop(0,'#221545');tg.addColorStop(1,'#120a28');cx.fillStyle=tg;cx.beginPath();cx.moveTo(mx+14*S,my);cx.lineTo(mx+mW-10*S,my);cx.quadraticCurveTo(mx+mW,my+mH/2,mx+mW-10*S,my+mH);cx.lineTo(mx+14*S,my+mH);cx.quadraticCurveTo(mx-2*S,my+mH/2,mx+14*S,my);cx.fill();cx.save();for(let wx=mx+20*S;wx<mx+mW-20*S;wx+=24*S){cx.fillStyle='rgba(0,255,255,.45)';if(Q){cx.shadowColor='#0ff';cx.shadowBlur=8*S}cx.fillRect(wx,my+4*S,15*S,9*S)}cx.restore();cx.save();cx.strokeStyle='#a855f7';cx.lineWidth=2*S;if(Q){cx.shadowColor='#a855f7';cx.shadowBlur=10*S}cx.beginPath();cx.moveTo(mx+10*S,my+mH);cx.lineTo(mx+mW-6*S,my+mH);cx.stroke();cx.restore()}
function dCar(x,y){cx.save();cx.translate(x,y);cx.scale(S,S);const ug=cx.createRadialGradient(0,50,4,0,50,42);ug.addColorStop(0,'rgba(0,255,255,.12)');ug.addColorStop(1,'transparent');cx.fillStyle=ug;cx.beginPath();cx.ellipse(0,50,36,16,0,0,6.28);cx.fill();cx.fillStyle='#15153a';cx.fillRect(-22,58,44,5);cx.save();cx.fillStyle='#0ff';if(Q){cx.shadowColor='#0ff';cx.shadowBlur=6}cx.fillRect(-22,63,44,1.5);cx.restore();cx.fillStyle='#0e0e14';cx.fillRect(-22,40,8,18);cx.fillRect(14,40,8,18);cx.fillStyle='#282830';cx.fillRect(-21,43,6,3);cx.fillRect(15,43,6,3);cx.fillRect(-21,51,6,3);cx.fillRect(15,51,6,3);const bg=cx.createLinearGradient(0,-30,0,55);bg.addColorStop(0,'#180e3a');bg.addColorStop(.4,'#10082a');bg.addColorStop(1,'#080420');cx.fillStyle=bg;cx.beginPath();cx.moveTo(0,-34);cx.lineTo(-10,-20);cx.lineTo(-14,10);cx.lineTo(-12,50);cx.lineTo(-8,58);cx.lineTo(8,58);cx.lineTo(12,50);cx.lineTo(14,10);cx.lineTo(10,-20);cx.closePath();cx.fill();cx.save();cx.strokeStyle='#0ff';cx.lineWidth=1.5;if(Q){cx.shadowColor='#0ff';cx.shadowBlur=8}cx.beginPath();cx.moveTo(-13,5);cx.lineTo(-11,48);cx.stroke();cx.beginPath();cx.moveTo(13,5);cx.lineTo(11,48);cx.stroke();cx.restore();cx.save();cx.strokeStyle='#a855f7';cx.lineWidth=1;if(Q){cx.shadowColor='#a855f7';cx.shadowBlur=5}cx.beginPath();cx.moveTo(-8,-15);cx.lineTo(-12,20);cx.stroke();cx.beginPath();cx.moveTo(8,-15);cx.lineTo(12,20);cx.stroke();cx.restore();cx.fillStyle='#0a0520';cx.beginPath();cx.moveTo(-14,10);cx.lineTo(-18,20);cx.lineTo(-16,42);cx.lineTo(-12,50);cx.closePath();cx.fill();cx.beginPath();cx.moveTo(14,10);cx.lineTo(18,20);cx.lineTo(16,42);cx.lineTo(12,50);cx.closePath();cx.fill();cx.fillStyle='#0e0e14';cx.fillRect(-20,-8,7,16);cx.fillRect(13,-8,7,16);cx.fillStyle='#15153a';cx.fillRect(-20,-14,40,4);cx.save();cx.fillStyle='#0ff';if(Q){cx.shadowColor='#0ff';cx.shadowBlur=8}cx.fillRect(-18,-18,36,2);cx.restore();cx.fillStyle='#140e30';cx.beginPath();cx.moveTo(-4,-34);cx.lineTo(4,-34);cx.lineTo(6,-24);cx.lineTo(-6,-24);cx.closePath();cx.fill();cx.save();cx.fillStyle='#0ff';if(Q){cx.shadowColor='#0ff';cx.shadowBlur=12}cx.beginPath();cx.arc(0,-34,2.5,0,6.28);cx.fill();cx.restore();cx.fillStyle='rgba(0,255,255,.12)';cx.beginPath();cx.ellipse(0,18,6,10,0,0,6.28);cx.fill();cx.strokeStyle='rgba(0,255,255,.25)';cx.lineWidth=.8;cx.stroke();cx.save();cx.fillStyle='#a855f7';if(Q){cx.shadowColor='#a855f7';cx.shadowBlur=6}cx.beginPath();cx.arc(0,14,4,0,6.28);cx.fill();cx.restore();cx.restore()}
function dObs(o){cx.save();cx.translate(o.x,o.y);cx.scale(S,S);if(o.t==='cone'){cx.save();cx.fillStyle='#ff6600';if(Q){cx.shadowColor='#ff6600';cx.shadowBlur=10}cx.beginPath();cx.moveTo(0,-15);cx.lineTo(-11,13);cx.lineTo(11,13);cx.closePath();cx.fill();cx.restore();cx.fillStyle='rgba(255,255,255,.7)';cx.beginPath();cx.moveTo(-4,-2);cx.lineTo(-7,6);cx.lineTo(7,6);cx.lineTo(4,-2);cx.closePath();cx.fill();cx.fillStyle='#ff5500';cx.fillRect(-13,11,26,5)}else if(o.t==='rock'){cx.save();cx.fillStyle='#3a3a50';if(Q){cx.shadowColor='rgba(168,85,247,.25)';cx.shadowBlur=8}cx.beginPath();cx.moveTo(-14,4);cx.lineTo(-10,-10);cx.lineTo(-2,-14);cx.lineTo(8,-12);cx.lineTo(16,-4);cx.lineTo(14,8);cx.lineTo(6,14);cx.lineTo(-8,12);cx.closePath();cx.fill();cx.restore();cx.fillStyle='#4a4a60';cx.beginPath();cx.moveTo(-8,-2);cx.lineTo(-4,-10);cx.lineTo(4,-10);cx.lineTo(2,-2);cx.closePath();cx.fill()}else{const og=cx.createLinearGradient(-12,0,12,0);og.addColorStop(0,'#221540');og.addColorStop(.5,'#301a58');og.addColorStop(1,'#221540');cx.save();cx.fillStyle=og;if(Q){cx.shadowColor='#a855f7';cx.shadowBlur=10}cx.beginPath();cx.ellipse(0,0,13,16,0,0,6.28);cx.fill();cx.restore();cx.save();cx.strokeStyle='#0ff';cx.lineWidth=1.5;if(Q){cx.shadowColor='#0ff';cx.shadowBlur=6}cx.beginPath();cx.moveTo(-13,-4);cx.lineTo(13,-4);cx.stroke();cx.beginPath();cx.moveTo(-13,4);cx.lineTo(13,4);cx.stroke();cx.restore();cx.fillStyle='#ff00aa';cx.font='bold 12px Orbitron';cx.textAlign='center';cx.fillText('!',0,4)}cx.restore()}
function col(a,b){const p=Math.round(10*S);return Math.abs(a.x-b.x)<(a.w/2+b.w/2-p)&&Math.abs((a.y+a.h/2)-b.y)<(a.h/2+b.h/2-p)}

function loop(g,now){
  if(g!==gen)return;
  if(!lt)lt=now;dt=Math.min((now-lt)/TD,3);lt=now;frm++;
  if(run){const mv=5.5*S*dt;let dx=0,dy=0;if(kp.ArrowLeft||kp.a||kp.A||dp.left)dx=-1;if(kp.ArrowRight||kp.d||kp.D||dp.right)dx=1;if(kp.ArrowUp||kp.w||kp.W||dp.up)dy=-1;if(kp.ArrowDown||kp.s||kp.S||dp.down)dy=1;if(dx&&dy){dx*=.7071;dy*=.7071}car.x+=dx*mv;car.y+=dy*mv;car.x=Math.max(RL+car.w/2+6,Math.min(RR-car.w/2-6,car.x));car.y=Math.max(car.h/2+Math.round(80*S),Math.min(H-car.h/2-10,car.y))}
  if(run){const d=gDif();speed=d.sp;if(d.l>lastLv){lastLv=d.l;showLv()}spAcc+=TD*dt;if(spAcc>=d.iv){spAcc-=d.iv;const r=Math.random();if(r<d.tc)spawnM(3);else if(r<d.tc+d.mc)spawnM(2);else spawn()}}
  for(let i=obs.length-1;i>=0;i--){obs[i].y+=speed*2*S*dt;if(obs[i].y>H+60){obs.splice(i,1);if(run){score++;$('sv').textContent=score;$('spd').textContent=Math.floor(60+gDif().l*30)}}}
  if(isInv){invT-=dt;if(invT<=0){isInv=false;invT=0}}
  if(run&&!dead&&!isInv&&!hitLk){for(let i=obs.length-1;i>=0;i--){if(col(car,obs[i])){hitO(i);break}}}
  while(ptc.length>MXP)ptc.shift();
  for(let i=ptc.length-1;i>=0;i--){const p=ptc[i];p.x+=p.vx*dt;p.y+=p.vy*dt;p.lf-=.02*dt;if(p.lf<=0)ptc.splice(i,1)}
  if(run||dead){uBld(bL,'l');uBld(bR,'r')}
  cx.clearRect(0,0,W,H);dBg();dRoad();dBld(bL);dBld(bR);dMono();
  for(let i=0;i<obs.length;i++){const o=obs[i];if(o.y+o.h<-20||o.y>H+40)continue;cx.fillStyle='rgba(168,85,247,.03)';cx.beginPath();cx.ellipse(o.x+3*S,o.y+o.h/2+5*S,o.w/2,5*S,0,0,6.28);cx.fill()}
  for(let i=0;i<obs.length;i++){if(obs[i].y+obs[i].h<-20||obs[i].y>H+40)continue;dObs(obs[i])}
  if(!dead){const sh=!isInv||(frm%6<3);if(sh){dCar(car.x,car.y);if(frm%3<2){const fl=(Math.random()*8+5)*S;const eg=cx.createLinearGradient(car.x,car.y+car.h-8*S,car.x,car.y+car.h+fl);eg.addColorStop(0,'rgba(0,255,255,.6)');eg.addColorStop(.4,'rgba(168,85,247,.35)');eg.addColorStop(1,'transparent');cx.fillStyle=eg;cx.beginPath();cx.moveTo(car.x-3*S,car.y+car.h-8*S);cx.lineTo(car.x+3*S,car.y+car.h-8*S);cx.lineTo(car.x+(Math.random()-.5)*4*S,car.y+car.h+fl);cx.closePath();cx.fill()}}if(isInv){cx.save();cx.globalAlpha=.2+Math.sin(frm*.3)*.12;cx.strokeStyle='#ff00aa';cx.lineWidth=2*S;if(Q){cx.shadowColor='#ff00aa';cx.shadowBlur=18*S}cx.beginPath();cx.ellipse(car.x,car.y+car.h/2-8*S,car.w/2+12*S,car.h/2+10*S,0,0,6.28);cx.stroke();cx.restore()}}
  for(let i=0;i<ptc.length;i++){const p=ptc[i];cx.save();cx.globalAlpha=p.lf;cx.fillStyle=p.c;if(PG){cx.shadowColor=p.c;cx.shadowBlur=8*S}cx.beginPath();cx.arc(p.x,p.y,p.r*p.lf,0,6.28);cx.fill();cx.restore()}
  const vt=cx.createLinearGradient(0,0,0,Math.round(40*S));vt.addColorStop(0,'rgba(3,3,20,.4)');vt.addColorStop(1,'transparent');cx.fillStyle=vt;cx.fillRect(0,0,W,Math.round(40*S));
  requestAnimationFrame(t=>loop(g,t));
}

(function init(){$('ssLB').innerHTML='<div class="lbw"><div class="lbt">üåê WORLD RANKING</div><div class="lbl">Connecting</div></div>';dBg();dRoad();dBld(bL);dBld(bR);startRT()})();
</script>
</body>
</html>
