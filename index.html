<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1.0,maximum-scale=1.0,user-scalable=no,viewport-fit=cover">
<title>NEON DRIFT - Cyberpunk Racer</title>
<style>
  @import url('https://fonts.googleapis.com/css2?family=Orbitron:wght@400;700;900&family=Rajdhani:wght@500;700&display=swap');
  *{margin:0;padding:0;box-sizing:border-box}
  html,body{width:100%;height:100%;overflow:hidden}
  body{background:#020210;font-family:'Rajdhani',sans-serif}
  #wrap{position:relative;width:100vw;height:100vh;height:100dvh;overflow:hidden}
  canvas{display:block;width:100%;height:100%;will-change:transform}
  #hud{position:absolute;top:max(1.5vh,env(safe-area-inset-top,0px));left:0;right:0;display:flex;justify-content:space-between;padding:0 2vw;pointer-events:none;z-index:2}
  .hb{background:rgba(5,5,20,0.75);border:1px solid rgba(0,255,255,0.25);border-radius:6px;padding:0.6vh 1.2vw;color:rgba(0,255,255,0.7);font-family:'Orbitron',monospace;font-size:clamp(11px,1.3vw,18px);backdrop-filter:blur(6px);box-shadow:0 0 12px rgba(0,255,255,0.08);text-shadow:0 0 6px rgba(0,255,255,0.3)}
  .hb span{color:#0ff;font-weight:700;font-size:clamp(14px,1.8vw,26px)}
  .hearts{display:flex;gap:clamp(3px,0.4vw,8px);align-items:center}
  .ht{font-size:clamp(16px,2vw,28px);transition:all .35s ease;filter:drop-shadow(0 0 6px rgba(255,0,170,0.6))}
  .ht.on{color:#ff00aa;text-shadow:0 0 10px rgba(255,0,170,0.6),0 0 20px rgba(255,0,170,0.3)}
  .ht.off{color:rgba(60,20,40,0.4);filter:none;transform:scale(0.8);text-shadow:none}
  .ht.pop{animation:htPop .5s ease-out forwards}
  @keyframes htPop{0%{transform:scale(1.5);color:#ff00aa;filter:drop-shadow(0 0 16px #ff00aa)}40%{transform:scale(0.6)}100%{transform:scale(0.8);color:rgba(60,20,40,0.4);filter:none}}
  .ov{position:absolute;inset:0;display:flex;flex-direction:column;justify-content:center;align-items:center;background:rgba(3,3,14,0.88);z-index:10;backdrop-filter:blur(10px)}
  #os{display:none}#ni{display:none;z-index:20}
  .tt{font-family:'Orbitron',monospace;font-size:clamp(28px,4.5vw,56px);font-weight:900;letter-spacing:clamp(4px,0.6vw,10px);background:linear-gradient(90deg,#0ff,#a855f7,#0ff);background-size:200% 100%;-webkit-background-clip:text;-webkit-text-fill-color:transparent;animation:sh 3s ease-in-out infinite;filter:drop-shadow(0 0 20px rgba(0,255,255,0.4));margin-bottom:4px}
  @keyframes sh{0%,100%{background-position:0% 50%}50%{background-position:100% 50%}}
  .st{font-size:clamp(12px,1.6vw,20px);color:rgba(168,85,247,0.6);margin-bottom:2.5vh;letter-spacing:clamp(2px,0.4vw,5px)}
  .bt{font-family:'Orbitron',monospace;font-size:clamp(12px,1.4vw,20px);background:transparent;color:#0ff;border:1px solid rgba(0,255,255,0.4);padding:1.2vh 3.5vw;border-radius:6px;cursor:pointer;letter-spacing:3px;transition:all .25s;box-shadow:0 0 20px rgba(0,255,255,0.1);text-shadow:0 0 10px rgba(0,255,255,0.6);margin-top:1vh}
  .bt:hover{background:rgba(0,255,255,0.08);box-shadow:0 0 30px rgba(0,255,255,0.25);border-color:#0ff}
  .fs{font-family:'Orbitron',monospace;font-size:clamp(36px,5vw,64px);color:#0ff;font-weight:900;margin:0.5vh 0;text-shadow:0 0 30px rgba(0,255,255,0.5)}
  .ky{color:rgba(168,85,247,0.35);font-size:clamp(10px,1.1vw,15px);margin-top:1.5vh;letter-spacing:1px}
  .lu{position:absolute;top:50%;left:50%;transform:translate(-50%,-50%);font-family:'Orbitron',monospace;font-size:clamp(22px,3.5vw,42px);font-weight:900;color:#0ff;text-shadow:0 0 30px #0ff,0 0 60px rgba(0,255,255,0.4);pointer-events:none;z-index:5;opacity:0;transition:opacity .3s}
  .music-btn{position:absolute;bottom:max(1.5vh,env(safe-area-inset-bottom,0px));right:2vw;z-index:3;background:rgba(5,5,20,0.7);border:1px solid rgba(168,85,247,0.3);border-radius:4px;padding:0.5vh 1vw;color:rgba(168,85,247,0.7);font:clamp(10px,1vw,14px) 'Orbitron',monospace;cursor:pointer;transition:all .2s}
  .music-btn:hover{border-color:#a855f7;color:#a855f7}
  .lb-wrap{width:clamp(240px,24vw,400px);margin:1.5vh auto .5vh;padding:1.2vh 0 .8vh;background:rgba(5,3,20,0.6);border:1px solid rgba(0,255,255,0.12);border-radius:6px;box-shadow:0 0 20px rgba(0,255,255,0.04),inset 0 0 30px rgba(0,0,0,0.3);max-height:40vh;overflow-y:auto}
  .lb-title{font-family:'Orbitron',monospace;font-size:clamp(10px,1.1vw,16px);font-weight:700;color:#a855f7;letter-spacing:3px;text-align:center;margin-bottom:1vh;text-transform:uppercase}
  .lb-row{display:flex;align-items:center;padding:.35vh 1.2vw;font-family:'Rajdhani',sans-serif;font-size:clamp(11px,1.1vw,17px)}
  .lb-row.highlight{background:rgba(0,255,255,0.06);border-left:2px solid #0ff}
  .lb-rank{width:clamp(18px,2vw,30px);font-family:'Orbitron',monospace;font-size:clamp(10px,1vw,15px);font-weight:700;color:#a855f7}
  .lb-rank.gold{color:#ffd700}.lb-rank.silver{color:#c0c0c0}.lb-rank.bronze{color:#cd7f32}
  .lb-name{flex:1;color:rgba(220,230,255,0.75);overflow:hidden;text-overflow:ellipsis;white-space:nowrap;padding:0 .6vw}
  .lb-score{font-family:'Orbitron',monospace;font-size:clamp(11px,1.1vw,17px);font-weight:700;color:#0ff}
  .lb-empty{text-align:center;color:rgba(168,85,247,0.3);font-size:clamp(10px,1vw,14px);padding:1vh 0;font-style:italic}
  .lb-new{animation:lbP 1s ease-in-out infinite}
  @keyframes lbP{0%,100%{text-shadow:0 0 6px rgba(0,255,255,0.3)}50%{text-shadow:0 0 16px rgba(0,255,255,0.7)}}
  .lb-loading{text-align:center;color:rgba(0,255,255,0.4);font-size:clamp(10px,1vw,14px);padding:1.5vh 0;font-style:italic}
  .lb-loading::after{content:'';display:inline-block;width:12px;height:12px;border:2px solid rgba(0,255,255,0.3);border-top-color:#0ff;border-radius:50%;animation:lbSpin .8s linear infinite;margin-left:6px;vertical-align:middle}
  @keyframes lbSpin{to{transform:rotate(360deg)}}
  .lb-badge{display:inline-block;font-family:'Orbitron',monospace;font-size:clamp(7px,0.7vw,10px);padding:1px 6px;border-radius:3px;margin-left:4px;vertical-align:middle}
  .lb-badge.global{background:rgba(168,85,247,0.2);color:#a855f7;border:1px solid rgba(168,85,247,0.3)}
  .lb-badge.local{background:rgba(0,255,255,0.1);color:rgba(0,255,255,0.5);border:1px solid rgba(0,255,255,0.15)}
  .ni-box{background:rgba(8,4,28,0.95);border:1px solid rgba(0,255,255,0.2);border-radius:8px;padding:3vh 3vw;text-align:center;box-shadow:0 0 40px rgba(0,255,255,0.08)}
  .ni-title{font-family:'Orbitron',monospace;font-size:clamp(14px,1.6vw,22px);font-weight:700;color:#0ff;letter-spacing:2px;margin-bottom:.5vh}
  .ni-sub{font-size:clamp(11px,1.2vw,16px);color:rgba(168,85,247,0.5);margin-bottom:1.5vh}
  .ni-score{font-family:'Orbitron',monospace;font-size:clamp(26px,3.5vw,46px);font-weight:900;color:#0ff;margin-bottom:1.5vh}
  .ni-input{width:clamp(150px,16vw,260px);background:rgba(0,0,0,0.4);border:1px solid rgba(0,255,255,0.2);border-radius:4px;padding:1vh 1.2vw;color:#0ff;font-family:'Orbitron',monospace;font-size:clamp(12px,1.3vw,18px);text-align:center;letter-spacing:2px;outline:none;caret-color:#0ff}
  .ni-input:focus{border-color:rgba(0,255,255,0.5);box-shadow:0 0 12px rgba(0,255,255,0.1)}
  .ni-input::placeholder{color:rgba(0,255,255,0.2)}
  .ni-btn{font-family:'Orbitron',monospace;font-size:clamp(10px,1.1vw,15px);background:rgba(0,255,255,0.08);color:#0ff;border:1px solid rgba(0,255,255,0.3);padding:1vh 2.5vw;border-radius:4px;cursor:pointer;letter-spacing:2px;margin-top:1.5vh;transition:all .2s}
  .ni-btn:hover{background:rgba(0,255,255,0.15)}
  .ni-saving{pointer-events:none;opacity:.5}
  /* 전광판 */
  .billboard{position:absolute;top:2vh;right:1.5vw;width:clamp(160px,14vw,280px);z-index:1;pointer-events:none}
  .bb-ambient{position:absolute;top:-10px;left:-15px;right:-15px;bottom:-20px;background:radial-gradient(ellipse at center 40%,rgba(255,0,170,0.03) 0%,transparent 65%);pointer-events:none;z-index:-1;animation:bbAmb 3s ease-in-out infinite}
  @keyframes bbAmb{0%,100%{opacity:.5}50%{opacity:1}}
  .bb-pole{position:absolute;bottom:-18%;width:3%;height:18%;background:linear-gradient(180deg,#4a4a60,#1a1a28);border:1px solid rgba(0,255,255,0.04)}
  .bb-pole.left{left:10%}.bb-pole.right{right:10%}
  .bb-frame{position:relative;width:100%;padding-bottom:75%;background:linear-gradient(180deg,#0e0e24,#0a0a1c,#060616);border:2px solid #2e2e48;border-radius:3px;box-shadow:0 0 14px rgba(0,255,255,0.1),0 0 35px rgba(168,85,247,0.07),inset 0 0 18px rgba(0,0,0,0.9);overflow:hidden}
  .bb-frame::after{content:'';position:absolute;inset:-4px;border-radius:5px;pointer-events:none;z-index:4;border:2px solid transparent;animation:bbFlk 2.2s ease-in-out infinite}
  @keyframes bbFlk{0%,100%{border-color:rgba(255,0,170,0.7);box-shadow:0 0 8px rgba(255,0,170,0.3)}50%{border-color:rgba(0,255,255,0.9);box-shadow:0 0 12px rgba(0,255,255,0.45)}80%{border-color:rgba(255,0,170,0.05);box-shadow:none}}
  .bb-neon-top{position:absolute;top:-2px;left:5%;right:5%;height:2px;background:#ff00aa;z-index:6;box-shadow:0 0 8px #ff00aa;animation:bbNT 1.5s ease-in-out infinite}
  @keyframes bbNT{0%,100%{opacity:.6}50%{opacity:1}}
  .bb-neon-bot{position:absolute;bottom:-2px;left:5%;right:5%;height:2px;background:#0ff;z-index:6;box-shadow:0 0 8px #0ff;animation:bbNB 1.8s ease-in-out infinite}
  @keyframes bbNB{0%,100%{opacity:.5}50%{opacity:1}}
  .bb-neon-l{position:absolute;top:6%;bottom:6%;left:-2px;width:2px;background:linear-gradient(180deg,#ff00aa,#a855f7,#0ff);z-index:6;animation:bbNS 2.5s ease-in-out infinite}
  .bb-neon-r{position:absolute;top:6%;bottom:6%;right:-2px;width:2px;background:linear-gradient(180deg,#0ff,#a855f7,#ff00aa);z-index:6;animation:bbNS 2.5s ease-in-out infinite;animation-delay:.8s}
  @keyframes bbNS{0%,100%{opacity:.5}50%{opacity:1}}
  .bb-dot{position:absolute;width:4px;height:4px;border-radius:50%;z-index:7;animation:bbDP 1.2s ease-in-out infinite}
  .bb-dot.tl{top:3%;left:2%;background:#ff00aa;box-shadow:0 0 6px #ff00aa}
  .bb-dot.tr{top:3%;right:2%;background:#0ff;box-shadow:0 0 6px #0ff;animation-delay:.3s}
  .bb-dot.bl{bottom:3%;left:2%;background:#0ff;box-shadow:0 0 6px #0ff;animation-delay:.6s}
  .bb-dot.br{bottom:3%;right:2%;background:#ff00aa;box-shadow:0 0 6px #ff00aa;animation-delay:.9s}
  @keyframes bbDP{0%,100%{opacity:.25;transform:scale(.7)}50%{opacity:1;transform:scale(1.3)}}
  .bb-screen{position:absolute;top:3%;left:2.5%;right:2.5%;bottom:14%;overflow:hidden;background:#000}
  .bb-screen iframe{width:100%!important;height:100%!important;border:none;pointer-events:none;display:block}
  .bb-screen::after{content:'';position:absolute;inset:0;background:linear-gradient(135deg,rgba(255,255,255,0.04) 0%,transparent 30%);pointer-events:none;z-index:2}
  .bb-screen::before{content:'';position:absolute;inset:0;z-index:2;pointer-events:none;background:repeating-linear-gradient(0deg,transparent,transparent 2px,rgba(0,0,0,0.05) 2px,rgba(0,0,0,0.05) 4px)}
  .bb-label{position:absolute;bottom:0;left:0;right:0;height:13%;display:flex;align-items:center;justify-content:center;background:linear-gradient(180deg,rgba(10,6,30,0.4),rgba(8,4,24,0.95));border-top:1px solid rgba(255,0,170,0.2);z-index:3}
  .bb-label span{font-family:'Orbitron',monospace;font-size:clamp(5px,0.6vw,9px);font-weight:700;color:#ff00aa;letter-spacing:3px;text-transform:uppercase;animation:bbTG 2s ease-in-out infinite}
  @keyframes bbTG{0%,100%{color:#ff00aa}50%{color:#0ff}}
  .bb-glow{width:70%;height:30%;margin:0 auto;background:radial-gradient(ellipse at top,rgba(255,0,170,0.06) 0%,transparent 70%);pointer-events:none}
  .bb-rivet{position:absolute;width:5px;height:5px;border-radius:50%;z-index:8;background:radial-gradient(circle at 35% 35%,#5a5a70,#2a2a40);border:1px solid rgba(0,255,255,0.06)}
  .bb-rivet.rtl{top:4%;left:2%}.bb-rivet.rtr{top:4%;right:2%}.bb-rivet.rbl{bottom:15%;left:2%}.bb-rivet.rbr{bottom:15%;right:2%}
  /* ═══ 모바일 D-Pad ═══ */
  .touch-zone{display:none;position:absolute;bottom:120px;bottom:calc(120px + env(safe-area-inset-bottom,0px));bottom:max(120px, calc(15vh + env(safe-area-inset-bottom,0px)));left:50%;transform:translateX(-50%);z-index:4;pointer-events:auto;opacity:.6}
  .touch-zone .dpad{position:relative;width:clamp(150px,32vw,220px);height:clamp(150px,32vw,220px)}
  .touch-zone .dbtn{position:absolute;background:rgba(0,255,255,0.08);border:1.5px solid rgba(0,255,255,0.35);border-radius:10px;display:flex;align-items:center;justify-content:center;color:rgba(0,255,255,0.7);font-size:clamp(20px,4.5vw,30px);user-select:none;-webkit-user-select:none;touch-action:manipulation;min-width:48px;min-height:48px;-webkit-tap-highlight-color:transparent;transition:background .05s,border-color .05s}
  .touch-zone .dbtn:active,.touch-zone .dbtn.pressed{background:rgba(0,255,255,0.35);border-color:#0ff;box-shadow:0 0 12px rgba(0,255,255,0.4),inset 0 0 8px rgba(0,255,255,0.15);color:#0ff}
  .touch-zone .dbtn.up{top:0;left:30%;width:40%;height:32%}
  .touch-zone .dbtn.down{bottom:0;left:30%;width:40%;height:32%}
  .touch-zone .dbtn.left{top:34%;left:0;width:32%;height:32%}
  .touch-zone .dbtn.right{top:34%;right:0;width:32%;height:32%}
</style>
</head>
<body>
<div id="wrap">
  <canvas id="c"></canvas>
  <div id="hud">
    <div class="hb"><div class="hearts"><span class="ht on" id="h0">♥</span><span class="ht on" id="h1">♥</span><span class="ht on" id="h2">♥</span></div></div>
    <div class="hb">SCORE <span id="sv">0</span></div>
    <div class="hb">SPEED <span id="sp">60</span> km/h</div>
  </div>
  <div class="lu" id="lu">SPEED UP!</div>
  <button class="music-btn" id="musicBtn">♫ ON</button>
  <div class="billboard">
    <div class="bb-ambient"></div>
    <div class="bb-pole left"></div><div class="bb-pole right"></div>
    <div class="bb-frame">
      <div class="bb-neon-top"></div><div class="bb-neon-bot"></div>
      <div class="bb-neon-l"></div><div class="bb-neon-r"></div>
      <div class="bb-dot tl"></div><div class="bb-dot tr"></div>
      <div class="bb-dot bl"></div><div class="bb-dot br"></div>
      <div class="bb-rivet rtl"></div><div class="bb-rivet rtr"></div>
      <div class="bb-rivet rbl"></div><div class="bb-rivet rbr"></div>
      <div class="bb-screen"><div id="ytFrame"></div></div>
      <div class="bb-label"><span>★ PLAVE LIVE ★</span></div>
    </div>
    <div class="bb-glow"></div>
  </div>
  <div class="touch-zone" id="touchPad">
    <div class="dpad">
      <div class="dbtn up" data-dir="up">▲</div>
      <div class="dbtn down" data-dir="down">▼</div>
      <div class="dbtn left" data-dir="left">◀</div>
      <div class="dbtn right" data-dir="right">▶</div>
    </div>
  </div>
  <div class="ov" id="ss">
    <div class="tt">NEON DRIFT</div>
    <div class="st">C Y B E R P U N K &nbsp; R A C E R</div>
    <div id="ssLB"></div>
    <button class="bt" id="sb">START</button>
    <div class="ky" id="ctrlHint">↑ ↓ ← → 또는 W A S D 키로 조작</div>
  </div>
  <div class="ov" id="os">
    <div class="tt" style="font-size:clamp(24px,3.5vw,44px)">WASTED</div>
    <div class="st">FINAL SCORE</div>
    <div class="fs" id="fsc">0</div>
    <div id="osLB"></div>
    <button class="bt" id="rb">RETRY</button>
    <div class="ky">R키로 즉시 재시작</div>
  </div>
  <div class="ov" id="ni">
    <div class="ni-box">
      <div class="ni-title">★ GLOBAL RECORD ★</div>
      <div class="ni-sub">전 세계 랭킹에 이름을 남기세요!</div>
      <div class="ni-score" id="niScore">0</div>
      <input class="ni-input" id="niInput" type="text" maxlength="8" placeholder="이름 입력" autocomplete="off"><br>
      <button class="ni-btn" id="niBtn">SAVE</button>
    </div>
  </div>
</div>

<!-- ═══════════════════════════════════════════
     ★★★ Firebase SDK (compat v10 CDN) ★★★
     ═══════════════════════════════════════════ -->
<script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore-compat.js"></script>
<script>
// ═══ Firebase 초기화 (try-catch 안전) ═══
var db=null,fbReady=false;
try{
  firebase.initializeApp({
    apiKey:"AIzaSyDsPGWA-KvoS3Yg5MXMMziFvaZ3F7f2I88",
    authDomain:"racing-game-28130.firebaseapp.com",
    projectId:"racing-game-28130",
    storageBucket:"racing-game-28130.firebasestorage.app",
    messagingSenderId:"200881814519",
    appId:"1:200881814519:web:4ef37fc6f4c6c5c1baccf2"
  });
  db=firebase.firestore();
  fbReady=true;
  console.log('[Firebase] ✅ Firestore 연결 성공');
}catch(e){
  console.warn('[Firebase] ❌ 초기화 실패 → localStorage 폴백 모드:',e);
}
</script>

<!-- ═══ YouTube BGM ═══ -->
<script>
var musicOn=true,ytReady=false,ytP=null,ytRetryCount=0,YT_ID='eHCYzIu-ij4';
var ytTag=document.createElement('script');ytTag.src='https://www.youtube.com/iframe_api';document.head.appendChild(ytTag);
function onYouTubeIframeAPIReady(){createPlayer()}
function createPlayer(){
  var scr=document.querySelector('.bb-screen');
  var sw=scr?scr.clientWidth:200,sh=scr?scr.clientHeight:140;
  var pv={autoplay:1,mute:1,loop:1,playlist:YT_ID,controls:0,disablekb:1,fs:0,rel:0,playsinline:1,modestbranding:1,showinfo:0,origin:window.location.origin||window.location.protocol+'//'+window.location.host,enablejsapi:1};
  if(typeof Q!=='undefined'&&Q===0) pv.vq='small';
  ytP=new YT.Player('ytFrame',{
    width:String(sw),height:String(sh),videoId:YT_ID,
    host:'https://www.youtube-nocookie.com',playerVars:pv,
    events:{
      onReady:function(e){ytReady=true;ytRetryCount=0;
        if(typeof Q!=='undefined'&&Q===0){try{e.target.setPlaybackQuality('small')}catch(ex){}}
        e.target.setVolume(100);e.target.playVideo();
        try{var f=document.querySelector('.bb-screen iframe');if(f)f.setAttribute('referrerpolicy','strict-origin-when-cross-origin')}catch(ex){}},
      onStateChange:function(e){if(e.data===YT.PlayerState.ENDED){e.target.seekTo(0);e.target.playVideo()}},
      onError:function(e){if(ytRetryCount<3){ytRetryCount++;setTimeout(function(){try{if(ytP&&ytP.destroy)ytP.destroy()}catch(ex){}ytReady=false;var s=document.querySelector('.bb-screen');if(s&&!document.getElementById('ytFrame')){var d=document.createElement('div');d.id='ytFrame';s.appendChild(d)}createPlayer()},1500*ytRetryCount)}}
    }
  });
}
function playMusic(){if(!musicOn)return;if(ytReady&&ytP){try{ytP.setVolume(100);ytP.unMute();ytP.playVideo()}catch(e){}}else{setTimeout(playMusic,500)}}
function stopMusic(){if(ytReady&&ytP)try{ytP.mute()}catch(e){}}
function toggleMusic(){musicOn=!musicOn;document.getElementById('musicBtn').textContent=musicOn?'♫ ON':'♫ OFF';if(!ytReady||!ytP)return;try{if(musicOn){ytP.unMute();ytP.setVolume(100);ytP.playVideo()}else{ytP.mute()}}catch(e){}}
document.getElementById('musicBtn').addEventListener('click',toggleMusic);
</script>

<!-- ═══ 게임 엔진 ═══ -->
<script>
var canvas=document.getElementById('c'),ctx=canvas.getContext('2d');

// ═══ 기기 감지 & 품질 ═══
var isMobile=(function(){
  if('ontouchstart' in window||navigator.maxTouchPoints>0)return true;
  if(/Android|iPhone|iPad|iPod|webOS|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent))return true;
  return window.innerWidth<=900;
})();
var Q=isMobile?0:1;
var MAX_PARTICLES=Q?150:40,GLOW_MULT=Q?1:0,WINDOW_DETAIL=Q?1:0,NEON_DETAIL=Q?1:0,SPEED_LINES=Q?5:2,GRID_DRAW=Q?1:0,PARTICLE_GLOW=Q?1:0;

if(isMobile){
  document.getElementById('touchPad').style.display='block';
  document.getElementById('ctrlHint').textContent='화면 하단 D-Pad로 조작';
  (function fixDpadPos(){
    var tp=document.getElementById('touchPad');if(!tp)return;
    var safeBottom=120;
    var vh=window.visualViewport?window.visualViewport.height:window.innerHeight;
    tp.style.bottom=Math.max(safeBottom,Math.round(vh*0.15))+'px';
    function recalcDpad(){var newH=window.visualViewport?window.visualViewport.height:window.innerHeight;tp.style.bottom=Math.max(safeBottom,Math.round(newH*0.15))+'px'}
    if(window.visualViewport)window.visualViewport.addEventListener('resize',recalcDpad);
    window.addEventListener('resize',recalcDpad);
  })();
}

// ═══ 동적 레이아웃 ═══
var W,H,S,ROAD_L,ROAD_R,ROAD_W,LANE_W;
function getViewH(){if(window.visualViewport)return Math.round(window.visualViewport.height);return window.innerHeight}
function getViewW(){if(window.visualViewport)return Math.round(window.visualViewport.width);return window.innerWidth}
function calcLayout(){
  W=getViewW();H=getViewH();canvas.width=W;canvas.height=H;S=H/760;
  ROAD_L=Math.round(W*0.175);ROAD_R=Math.round(W*0.825);ROAD_W=ROAD_R-ROAD_L;LANE_W=ROAD_W/4;
  var wrap=document.getElementById('wrap');if(wrap){wrap.style.width=W+'px';wrap.style.height=H+'px'}
}
calcLayout();

var LB_MAX=10,generation=0;
var run=0,dead=0,score=0,speed=1.5,frame=0,lastLv=0,roadOff=0,gridOff=0;
var kp={},car={x:0,y:0,w:0,h:0};
function initCarSize(){car.w=Math.round(38*S);car.h=Math.round(72*S)}
initCarSize();car.x=W/2;car.y=H-Math.round(110*S);
var obstacles=[],particles=[],pendingScore=null;
var MAX_LIVES=3,lives=3,isInvincible=false,invTimer=0,INV_DURATION=90,hitLock=false;

function onLayoutChange(){var oW=W,oH=H;calcLayout();initCarSize();if(oW>0&&oH>0){car.x=car.x*(W/oW);car.y=car.y*(H/oH)}initBld()}
window.addEventListener('resize',onLayoutChange);
if(window.visualViewport)window.visualViewport.addEventListener('resize',onLayoutChange);

// ═══════════════════════════════════════════════════
// ★★★ 리더보드: Firestore 글로벌 + localStorage 폴백 ★★★
// ═══════════════════════════════════════════════════════

var LB_LOCAL_KEY='neonDriftLB';
var cachedGlobalLB=[];

// --- localStorage 폴백 ---
function localLbLoad(){try{var d=localStorage.getItem(LB_LOCAL_KEY);if(d){var a=JSON.parse(d);if(Array.isArray(a))return a.slice(0,LB_MAX)}}catch(e){}return[]}
function localLbSave(a){try{localStorage.setItem(LB_LOCAL_KEY,JSON.stringify(a.slice(0,LB_MAX)))}catch(e){}}

// --- Firestore TOP 10 읽기 ---
async function fbLoadLeaderboard(){
  if(!fbReady||!db) return localLbLoad();
  try{
    var snap=await db.collection('leaderboard').orderBy('score','desc').limit(LB_MAX).get();
    var list=[];
    snap.forEach(function(doc){var d=doc.data();list.push({name:d.name||'???',score:d.score||0})});
    cachedGlobalLB=list;
    localLbSave(list);
    return list;
  }catch(e){
    console.warn('[Firebase] 읽기 실패:',e);
    return localLbLoad();
  }
}

// --- Firestore 점수 저장 ---
async function fbSaveScore(name,sc){
  if(!fbReady||!db){
    var lb=localLbLoad();lb.push({name:name,score:sc});lb.sort(function(a,b){return b.score-a.score});localLbSave(lb);return;
  }
  try{
    await db.collection('leaderboard').add({name:name,score:sc,timestamp:firebase.firestore.FieldValue.serverTimestamp()});
    console.log('[Firebase] ✅ 저장 완료:',name,sc);
  }catch(e){
    console.warn('[Firebase] 저장 실패:',e);
    var lb=localLbLoad();lb.push({name:name,score:sc});lb.sort(function(a,b){return b.score-a.score});localLbSave(lb);
  }
}

// --- 렌더링 헬퍼 ---
function escH(s){return String(s).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;')}

function lbRenderData(tid,data,hl,isGlobal){
  var el=document.getElementById(tid);if(!el)return;
  var badge=isGlobal?'<span class="lb-badge global">GLOBAL</span>':'<span class="lb-badge local">LOCAL</span>';
  if(!data||!data.length){el.innerHTML='<div class="lb-wrap"><div class="lb-title">LEADERBOARD '+badge+'</div><div class="lb-empty">아직 기록이 없습니다</div></div>';return}
  var h='<div class="lb-wrap"><div class="lb-title">LEADERBOARD '+badge+'</div>';
  for(var i=0;i<data.length;i++){
    var e=data[i],rc=i===0?'gold':i===1?'silver':i===2?'bronze':'';
    var isH=hl!=null&&e.score===hl;
    h+='<div class="lb-row'+(isH?' highlight':'')+'"><div class="lb-rank '+rc+'">'+(i+1)+'</div><div class="lb-name">'+escH(e.name)+'</div><div class="lb-score'+(isH?' lb-new':'')+'">'+e.score+'</div></div>';
  }
  el.innerHTML=h+'</div>';
}

function lbRenderLoading(tid){
  var el=document.getElementById(tid);if(!el)return;
  el.innerHTML='<div class="lb-wrap"><div class="lb-title">LEADERBOARD</div><div class="lb-loading">불러오는 중</div></div>';
}

async function lbRender(tid,hl){
  var localData=cachedGlobalLB.length?cachedGlobalLB:localLbLoad();
  lbRenderData(tid,localData,hl,cachedGlobalLB.length>0);
  if(fbReady){try{var fresh=await fbLoadLeaderboard();lbRenderData(tid,fresh,hl,true)}catch(e){}}
}

// ═══ 빌딩 ═══
var bldL=[],bldR=[];
function mkBld(side){
  var w=Math.round((18+Math.random()*28)*S),h=Math.round((35+Math.random()*65)*S);
  var x=side==='l'?Math.random()*Math.max(10,ROAD_L-w-4):ROAD_R+4+Math.random()*Math.max(10,W-ROAD_R-w-4);
  var neons=[];var nc=Q?(1+~~(Math.random()*3)):1;
  for(var i=0;i<nc;i++)neons.push({ry:.15+Math.random()*.55,rw:.25+Math.random()*.5,c:['#0ff','#a855f7','#ff00aa','#00ff88','#0af'][~~(Math.random()*5)],b:Math.random()*6.28,s:.008+Math.random()*.025});
  return{x:x,y:-h,w:w,h:h,neons:neons,wr:Math.max(1,~~(h/(11*S))),wc:Math.max(1,~~(w/(8*S))),win:Q?Math.random()>.25:Math.random()>.6,bc:'rgb('+~~(5+Math.random()*10)+','+~~(5+Math.random()*8)+','+~~(15+Math.random()*15)+')'}
}
function initBld(){bldL=[];bldR=[];var g=Math.round(80*S);var ly=-g;while(ly<H+g){var b=mkBld('l');b.y=ly;bldL.push(b);ly+=b.h+Math.round((3+Math.random()*8)*S)}var ry=-g;while(ry<H+g){var b2=mkBld('r');b2.y=ry;bldR.push(b2);ry+=b2.h+Math.round((3+Math.random()*8)*S)}}
initBld();
var mono={x:-Math.round(220*S),y:0,s:.6,on:0,t:0};

// ═══ 하트/피격 (5중 안전장치) ═══
function updateHearts(){for(var i=0;i<MAX_LIVES;i++){var el=document.getElementById('h'+i);if(el)el.className=(i<lives)?'ht on':'ht off'}}
function loseHeartAnim(idx){var el=document.getElementById('h'+idx);if(el)el.className='ht pop'}
function hitObstacle(oi){
  if(isInvincible||hitLock||lives<=0)return;
  hitLock=true;lives--;loseHeartAnim(lives);
  if(oi>=0&&oi<obstacles.length)obstacles.splice(oi,1);
  var pc=Q?15:8;
  for(var i=0;i<pc;i++)particles.push({x:car.x,y:car.y+car.h/2,vx:(Math.random()-.5)*8*S,vy:(Math.random()-.5)*8*S,r:(1.5+Math.random()*3)*S,life:.7,c:['#ff00aa','#a855f7','#fff'][~~(Math.random()*3)]});
  if(lives<=0){hitLock=false;die()}else{isInvincible=true;invTimer=INV_DURATION;car.y=Math.min(car.y+Math.round(60*S),H-car.h/2-10);hitLock=false}
}
function die(){
  dead=1;run=0;isInvincible=false;hitLock=false;var fs=score;
  var pc=Q?40:20;
  for(var i=0;i<pc;i++)particles.push({x:car.x,y:car.y+car.h/2,vx:(Math.random()-.5)*10*S,vy:(Math.random()-.5)*10*S,r:(2+Math.random()*5)*S,life:1,c:['#0ff','#a855f7','#ff00aa','#fff','#00ff88'][~~(Math.random()*5)]});
  setTimeout(function(){if(fs>0)showNameInput(fs);else showGameOver(fs)},900);
}

// ═══ 키보드 입력 ═══
document.addEventListener('keydown',function(e){if(document.getElementById('ni').style.display==='flex'){if(e.key==='Enter')submitName();return}kp[e.key]=1;if((e.key==='r'||e.key==='R')&&dead)restart();if((e.key===' '||e.key==='Enter')&&!run&&!dead)startGame()});
document.addEventListener('keyup',function(e){kp[e.key]=0});
document.getElementById('sb').onclick=startGame;
document.getElementById('rb').onclick=restart;
document.getElementById('niBtn').onclick=submitName;

// ═══ 터치 스와이프 ═══
var touchX=null,touchY=null;
canvas.addEventListener('touchstart',function(e){e.preventDefault();touchX=e.touches[0].clientX;touchY=e.touches[0].clientY},{passive:false});
canvas.addEventListener('touchmove',function(e){e.preventDefault();if(touchX!==null){var dx=e.touches[0].clientX-touchX,dy=e.touches[0].clientY-touchY;if(Math.abs(dx)>8){car.x+=dx>0?5*S:-5*S;touchX=e.touches[0].clientX}if(Math.abs(dy)>8){car.y+=dy>0?5*S:-5*S;touchY=e.touches[0].clientY}}},{passive:false});
canvas.addEventListener('touchend',function(){touchX=null;touchY=null});

// ═══ D-Pad ═══
var dpadState={up:0,down:0,left:0,right:0};
(function(){
  var btns=document.querySelectorAll('.dbtn');
  for(var i=0;i<btns.length;i++){
    (function(btn){
      var dir=btn.getAttribute('data-dir');
      btn.addEventListener('touchstart',function(e){e.preventDefault();e.stopPropagation();dpadState[dir]=1;btn.classList.add('pressed')},{passive:false});
      btn.addEventListener('touchend',function(e){e.preventDefault();e.stopPropagation();dpadState[dir]=0;btn.classList.remove('pressed')},{passive:false});
      btn.addEventListener('touchcancel',function(){dpadState[dir]=0;btn.classList.remove('pressed')});
      btn.addEventListener('touchmove',function(e){var t=e.touches[0];var r=btn.getBoundingClientRect();if(t.clientX<r.left||t.clientX>r.right||t.clientY<r.top||t.clientY>r.bottom){dpadState[dir]=0;btn.classList.remove('pressed')}},{passive:true});
    })(btns[i]);
  }
})();

// ═══ 이름 입력 & Firebase 저장 ═══
function showNameInput(sc){
  pendingScore=sc;document.getElementById('niScore').textContent=sc;
  document.getElementById('niInput').value='';
  document.getElementById('niBtn').classList.remove('ni-saving');
  document.getElementById('niBtn').textContent='SAVE';
  document.getElementById('ni').style.display='flex';
  setTimeout(function(){document.getElementById('niInput').focus()},100);
}
async function submitName(){
  var name=document.getElementById('niInput').value.trim();
  if(!name)name='RACER';if(name.length>8)name=name.slice(0,8);
  var btn=document.getElementById('niBtn');
  btn.classList.add('ni-saving');btn.textContent='SAVING...';
  try{await fbSaveScore(name,pendingScore)}catch(e){console.warn('[Save]',e)}
  document.getElementById('ni').style.display='none';
  btn.classList.remove('ni-saving');btn.textContent='SAVE';
  showGameOver(pendingScore);pendingScore=null;
}
async function showGameOver(sc){
  document.getElementById('fsc').textContent=sc;
  lbRenderLoading('osLB');
  document.getElementById('os').style.display='flex';
  await lbRender('osLB',sc);
}

function spawn(){var type=['cone','rock','barrel'][~~(Math.random()*3)];var margin=Math.round(18*S);var cx=ROAD_L+margin+Math.random()*(ROAD_W-margin*2);var w,h;if(type==='cone'){w=Math.round(24*S);h=Math.round(30*S)}else if(type==='rock'){w=Math.round(36*S);h=Math.round(28*S)}else{w=Math.round(28*S);h=Math.round(32*S)}obstacles.push({type:type,x:cx,y:-Math.round(50*S),w:w,h:h})}
function showLv(){var e=document.getElementById('lu');e.style.opacity='1';setTimeout(function(){e.style.opacity='0'},1200)}

// ═══ 리셋 ═══
function resetAll(){
  generation++;run=1;dead=0;score=0;speed=1.5;frame=0;lastLv=0;roadOff=0;gridOff=0;
  calcLayout();initCarSize();car.x=W/2;car.y=H-Math.round(110*S);
  obstacles=[];particles=[];lives=3;isInvincible=false;invTimer=0;hitLock=false;
  for(var k in kp)kp[k]=0;dpadState={up:0,down:0,left:0,right:0};
  initBld();mono={x:-Math.round(220*S),y:0,s:.6*S,on:0,t:0};
  document.getElementById('sv').textContent='0';document.getElementById('sp').textContent='60';updateHearts();
}
function startGame(){document.getElementById('ss').style.display='none';document.getElementById('ni').style.display='none';resetAll();playMusic();requestAnimationFrame(function(){loop(generation)})}
function restart(){document.getElementById('os').style.display='none';document.getElementById('ni').style.display='none';resetAll();playMusic();requestAnimationFrame(function(){loop(generation)})}

// ═══ 그리기 ═══
function drawBg(){ctx.fillStyle='#04041a';ctx.fillRect(0,0,W,H)}
function drawScrollBld(arr){for(var bi=0;bi<arr.length;bi++){var b=arr[bi];if(b.y+b.h<-10||b.y>H+10)continue;var bg=ctx.createLinearGradient(b.x,b.y,b.x+b.w,b.y+b.h);bg.addColorStop(0,b.bc);bg.addColorStop(1,'#040412');ctx.fillStyle=bg;ctx.fillRect(b.x,b.y,b.w,b.h);ctx.strokeStyle='rgba(0,255,255,.04)';ctx.lineWidth=.5;ctx.strokeRect(b.x,b.y,b.w,b.h);if(b.win){var ww=4*S,wh=5*S,gX=Math.max(6*S,(b.w-4*S)/b.wc),gY=Math.max(8*S,(b.h-6*S)/b.wr);if(WINDOW_DETAIL){for(var r=0;r<b.wr;r++)for(var c=0;c<b.wc;c++){var wx=b.x+3*S+c*gX,wy=b.y+4*S+r*gY;if(wy<b.y||wy+wh>b.y+b.h)continue;if(Math.sin(wx*5.3+wy*3.7+frame*.001)>.1){ctx.fillStyle='rgba(0,255,255,'+(.03+Math.sin(wx*.3+wy*.2+frame*.004)*.02)+')';ctx.fillRect(wx,wy,ww,wh)}}}else{ctx.fillStyle='rgba(0,255,255,0.035)';for(var r=0;r<b.wr;r+=2)for(var c=0;c<b.wc;c+=2){var wx=b.x+3*S+c*gX,wy=b.y+4*S+r*gY;if(wy>=b.y&&wy+wh<=b.y+b.h)ctx.fillRect(wx,wy,ww,wh)}}}for(var ni=0;ni<b.neons.length;ni++){var n=b.neons[ni];n.b+=n.s;var na=.4+Math.sin(n.b)*.4,ny=b.y+b.h*n.ry,nw=b.w*n.rw,nx=b.x+(b.w-nw)/2;if(ny<b.y||ny>b.y+b.h)continue;ctx.save();ctx.globalAlpha=na*.8;if(NEON_DETAIL){ctx.shadowColor=n.c;ctx.shadowBlur=14*S}ctx.fillStyle=n.c;ctx.fillRect(nx,ny,nw,2.5*S);ctx.restore()}}}
function updBld(arr,side){var s=speed*2*S;for(var i=0;i<arr.length;i++)arr[i].y+=s;for(var i=arr.length-1;i>=0;i--){if(arr[i].y>H+10){arr.splice(i,1);var nb=mkBld(side);var topY=H;for(var j=0;j<arr.length;j++)if(arr[j].y<topY)topY=arr[j].y;nb.y=topY-nb.h-Math.round((3+Math.random()*8)*S);arr.push(nb)}}}
function drawRoad(){var rg=ctx.createLinearGradient(ROAD_L,0,ROAD_R,0);rg.addColorStop(0,'#0d0d18');rg.addColorStop(.03,'#111120');rg.addColorStop(.97,'#111120');rg.addColorStop(1,'#0d0d18');ctx.fillStyle=rg;ctx.fillRect(ROAD_L,0,ROAD_W,H);if(GRID_DRAW){var gs=Math.round(28*S);gridOff=(gridOff+speed*1.8*S)%gs;ctx.strokeStyle='rgba(0,255,255,.02)';ctx.lineWidth=.5;for(var gy=-gs+gridOff;gy<H;gy+=gs){ctx.beginPath();ctx.moveTo(ROAD_L+2,gy);ctx.lineTo(ROAD_R-2,gy);ctx.stroke()}for(var gx=ROAD_L+gs/2;gx<ROAD_R;gx+=gs){ctx.beginPath();ctx.moveTo(gx,0);ctx.lineTo(gx,H);ctx.stroke()}}roadOff+=speed*2.5*S;ctx.save();ctx.strokeStyle='#0ff';ctx.lineWidth=2.5*S;if(Q){ctx.shadowColor='#0ff';ctx.shadowBlur=18*S}ctx.beginPath();ctx.moveTo(ROAD_L,0);ctx.lineTo(ROAD_L,H);ctx.stroke();ctx.beginPath();ctx.moveTo(ROAD_R,0);ctx.lineTo(ROAD_R,H);ctx.stroke();ctx.restore();var eg=Math.round(30*S);var rl=ctx.createLinearGradient(ROAD_L,0,ROAD_L+eg,0);rl.addColorStop(0,'rgba(0,255,255,.04)');rl.addColorStop(1,'transparent');ctx.fillStyle=rl;ctx.fillRect(ROAD_L,0,eg,H);var rr=ctx.createLinearGradient(ROAD_R,0,ROAD_R-eg,0);rr.addColorStop(0,'rgba(0,255,255,.04)');rr.addColorStop(1,'transparent');ctx.fillStyle=rr;ctx.fillRect(ROAD_R-eg,0,eg,H);ctx.save();ctx.setLineDash([26*S,20*S]);ctx.lineDashOffset=-roadOff;ctx.strokeStyle='rgba(168,85,247,.3)';ctx.lineWidth=1.5*S;if(Q){ctx.shadowColor='#a855f7';ctx.shadowBlur=5*S}for(var li=1;li<4;li++){var lx=ROAD_L+LANE_W*li;ctx.beginPath();ctx.moveTo(lx,0);ctx.lineTo(lx,H);ctx.stroke()}ctx.restore();if(speed>2){var la=Math.min((speed-2)*.03,.12);ctx.strokeStyle='rgba(0,255,255,'+la+')';ctx.lineWidth=.8*S;for(var si=0;si<SPEED_LINES;si++){var sx=ROAD_L+15*S+Math.random()*(ROAD_W-30*S),sy=Math.random()*H;ctx.beginPath();ctx.moveTo(sx,sy);ctx.lineTo(sx,sy+(15+speed*7)*S);ctx.stroke()}}}
function drawMono(){mono.t++;var mW=Math.round(200*S),mH=Math.round(22*S);if(!mono.on&&mono.t>350){mono.on=1;mono.x=-Math.round(240*S);mono.t=0;mono.y=Math.round((25+Math.random()*40)*S);mono.s=(.5+Math.random()*.4)*S}if(!mono.on)return;mono.x+=mono.s;if(mono.x>W+mW+60){mono.on=0;mono.t=0;return}var mx=mono.x,my=mono.y;ctx.strokeStyle='rgba(168,85,247,.15)';ctx.lineWidth=1.5*S;ctx.beginPath();ctx.moveTo(0,my+mH+2);ctx.lineTo(W,my+mH+2);ctx.stroke();var tg=ctx.createLinearGradient(mx,my,mx,my+mH);tg.addColorStop(0,'#221545');tg.addColorStop(1,'#120a28');ctx.fillStyle=tg;ctx.beginPath();ctx.moveTo(mx+14*S,my);ctx.lineTo(mx+mW-10*S,my);ctx.quadraticCurveTo(mx+mW,my+mH/2,mx+mW-10*S,my+mH);ctx.lineTo(mx+14*S,my+mH);ctx.quadraticCurveTo(mx-2*S,my+mH/2,mx+14*S,my);ctx.fill();ctx.save();for(var wx=mx+20*S;wx<mx+mW-20*S;wx+=24*S){ctx.fillStyle='rgba(0,255,255,.45)';if(Q){ctx.shadowColor='#0ff';ctx.shadowBlur=8*S}ctx.fillRect(wx,my+4*S,15*S,9*S)}ctx.restore();ctx.save();ctx.strokeStyle='#a855f7';ctx.lineWidth=2*S;if(Q){ctx.shadowColor='#a855f7';ctx.shadowBlur=10*S}ctx.beginPath();ctx.moveTo(mx+10*S,my+mH);ctx.lineTo(mx+mW-6*S,my+mH);ctx.stroke();ctx.restore()}
function drawCar(x,y){ctx.save();ctx.translate(x,y);ctx.scale(S,S);var ug=ctx.createRadialGradient(0,50,4,0,50,42);ug.addColorStop(0,'rgba(0,255,255,.12)');ug.addColorStop(1,'transparent');ctx.fillStyle=ug;ctx.beginPath();ctx.ellipse(0,50,36,16,0,0,6.28);ctx.fill();ctx.fillStyle='#15153a';ctx.fillRect(-22,58,44,5);ctx.save();ctx.fillStyle='#0ff';if(Q){ctx.shadowColor='#0ff';ctx.shadowBlur=6}ctx.fillRect(-22,63,44,1.5);ctx.restore();ctx.fillStyle='#0e0e14';ctx.fillRect(-22,40,8,18);ctx.fillRect(14,40,8,18);ctx.fillStyle='#282830';ctx.fillRect(-21,43,6,3);ctx.fillRect(15,43,6,3);ctx.fillRect(-21,51,6,3);ctx.fillRect(15,51,6,3);var bg=ctx.createLinearGradient(0,-30,0,55);bg.addColorStop(0,'#180e3a');bg.addColorStop(.4,'#10082a');bg.addColorStop(1,'#080420');ctx.fillStyle=bg;ctx.beginPath();ctx.moveTo(0,-34);ctx.lineTo(-10,-20);ctx.lineTo(-14,10);ctx.lineTo(-12,50);ctx.lineTo(-8,58);ctx.lineTo(8,58);ctx.lineTo(12,50);ctx.lineTo(14,10);ctx.lineTo(10,-20);ctx.closePath();ctx.fill();ctx.save();ctx.strokeStyle='#0ff';ctx.lineWidth=1.5;if(Q){ctx.shadowColor='#0ff';ctx.shadowBlur=8}ctx.beginPath();ctx.moveTo(-13,5);ctx.lineTo(-11,48);ctx.stroke();ctx.beginPath();ctx.moveTo(13,5);ctx.lineTo(11,48);ctx.stroke();ctx.restore();ctx.save();ctx.strokeStyle='#a855f7';ctx.lineWidth=1;if(Q){ctx.shadowColor='#a855f7';ctx.shadowBlur=5}ctx.beginPath();ctx.moveTo(-8,-15);ctx.lineTo(-12,20);ctx.stroke();ctx.beginPath();ctx.moveTo(8,-15);ctx.lineTo(12,20);ctx.stroke();ctx.restore();ctx.fillStyle='#0a0520';ctx.beginPath();ctx.moveTo(-14,10);ctx.lineTo(-18,20);ctx.lineTo(-16,42);ctx.lineTo(-12,50);ctx.closePath();ctx.fill();ctx.beginPath();ctx.moveTo(14,10);ctx.lineTo(18,20);ctx.lineTo(16,42);ctx.lineTo(12,50);ctx.closePath();ctx.fill();ctx.fillStyle='#0e0e14';ctx.fillRect(-20,-8,7,16);ctx.fillRect(13,-8,7,16);ctx.fillStyle='#15153a';ctx.fillRect(-20,-14,40,4);ctx.save();ctx.fillStyle='#0ff';if(Q){ctx.shadowColor='#0ff';ctx.shadowBlur=8}ctx.fillRect(-18,-18,36,2);ctx.restore();ctx.fillStyle='#140e30';ctx.beginPath();ctx.moveTo(-4,-34);ctx.lineTo(4,-34);ctx.lineTo(6,-24);ctx.lineTo(-6,-24);ctx.closePath();ctx.fill();ctx.save();ctx.fillStyle='#0ff';if(Q){ctx.shadowColor='#0ff';ctx.shadowBlur=12}ctx.beginPath();ctx.arc(0,-34,2.5,0,6.28);ctx.fill();ctx.restore();ctx.fillStyle='rgba(0,255,255,.12)';ctx.beginPath();ctx.ellipse(0,18,6,10,0,0,6.28);ctx.fill();ctx.strokeStyle='rgba(0,255,255,.25)';ctx.lineWidth=.8;ctx.stroke();ctx.save();ctx.fillStyle='#a855f7';if(Q){ctx.shadowColor='#a855f7';ctx.shadowBlur=6}ctx.beginPath();ctx.arc(0,14,4,0,6.28);ctx.fill();ctx.restore();ctx.restore()}
function drawObs(o){ctx.save();ctx.translate(o.x,o.y);ctx.scale(S,S);if(o.type==='cone'){ctx.save();ctx.fillStyle='#ff6600';if(Q){ctx.shadowColor='#ff6600';ctx.shadowBlur=10}ctx.beginPath();ctx.moveTo(0,-15);ctx.lineTo(-11,13);ctx.lineTo(11,13);ctx.closePath();ctx.fill();ctx.restore();ctx.fillStyle='rgba(255,255,255,.7)';ctx.beginPath();ctx.moveTo(-4,-2);ctx.lineTo(-7,6);ctx.lineTo(7,6);ctx.lineTo(4,-2);ctx.closePath();ctx.fill();ctx.fillStyle='#ff5500';ctx.fillRect(-13,11,26,5)}else if(o.type==='rock'){ctx.save();ctx.fillStyle='#3a3a50';if(Q){ctx.shadowColor='rgba(168,85,247,.25)';ctx.shadowBlur=8}ctx.beginPath();ctx.moveTo(-14,4);ctx.lineTo(-10,-10);ctx.lineTo(-2,-14);ctx.lineTo(8,-12);ctx.lineTo(16,-4);ctx.lineTo(14,8);ctx.lineTo(6,14);ctx.lineTo(-8,12);ctx.closePath();ctx.fill();ctx.restore();ctx.fillStyle='#4a4a60';ctx.beginPath();ctx.moveTo(-8,-2);ctx.lineTo(-4,-10);ctx.lineTo(4,-10);ctx.lineTo(2,-2);ctx.closePath();ctx.fill()}else{var obg=ctx.createLinearGradient(-12,0,12,0);obg.addColorStop(0,'#221540');obg.addColorStop(.5,'#301a58');obg.addColorStop(1,'#221540');ctx.save();ctx.fillStyle=obg;if(Q){ctx.shadowColor='#a855f7';ctx.shadowBlur=10}ctx.beginPath();ctx.ellipse(0,0,13,16,0,0,6.28);ctx.fill();ctx.restore();ctx.save();ctx.strokeStyle='#0ff';ctx.lineWidth=1.5;if(Q){ctx.shadowColor='#0ff';ctx.shadowBlur=6}ctx.beginPath();ctx.moveTo(-13,-4);ctx.lineTo(13,-4);ctx.stroke();ctx.beginPath();ctx.moveTo(-13,4);ctx.lineTo(13,4);ctx.stroke();ctx.restore();ctx.fillStyle='#ff00aa';ctx.font='bold 12px Orbitron';ctx.textAlign='center';ctx.fillText('!',0,4)}ctx.restore()}
function collides(a,b){var pad=Math.round(10*S);return Math.abs(a.x-b.x)<(a.w/2+b.w/2-pad)&&Math.abs((a.y+a.h/2)-b.y)<(a.h/2+b.h/2-pad)}

// ═══ 메인 루프 ═══
function loop(gen){
  if(gen!==generation)return;
  frame++;
  if(run){
    var mv=5.5*S,dx=0,dy=0;
    if(kp['ArrowLeft']||kp['a']||kp['A']||dpadState.left)dx=-1;
    if(kp['ArrowRight']||kp['d']||kp['D']||dpadState.right)dx=1;
    if(kp['ArrowUp']||kp['w']||kp['W']||dpadState.up)dy=-1;
    if(kp['ArrowDown']||kp['s']||kp['S']||dpadState.down)dy=1;
    if(dx!==0&&dy!==0){dx*=0.7071;dy*=0.7071}
    car.x+=dx*mv;car.y+=dy*mv;
    car.x=Math.max(ROAD_L+car.w/2+6,Math.min(ROAD_R-car.w/2-6,car.x));
    car.y=Math.max(car.h/2+Math.round(80*S),Math.min(H-car.h/2-10,car.y));
  }
  if(run){var lv=Math.floor(score/20);speed=1.5+lv*0.8;if(speed>10)speed=10;if(lv>lastLv){lastLv=lv;showLv()}}
  if(run&&frame%Math.max(30,70-Math.floor(score/20)*8)===0)spawn();
  for(var oi=obstacles.length-1;oi>=0;oi--){obstacles[oi].y+=speed*2*S;if(obstacles[oi].y>H+60){obstacles.splice(oi,1);if(run){score++;document.getElementById('sv').textContent=score;document.getElementById('sp').textContent=Math.floor(60+Math.floor(score/20)*30)}}}
  if(isInvincible){invTimer--;if(invTimer<=0){isInvincible=false;invTimer=0}}
  if(run&&!dead&&!isInvincible&&!hitLock){for(var ci=obstacles.length-1;ci>=0;ci--){if(collides(car,obstacles[ci])){hitObstacle(ci);break}}}
  while(particles.length>MAX_PARTICLES)particles.shift();
  for(var pi=particles.length-1;pi>=0;pi--){var p=particles[pi];p.x+=p.vx;p.y+=p.vy;p.life-=.02;if(p.life<=0)particles.splice(pi,1)}
  if(run||dead){updBld(bldL,'l');updBld(bldR,'r')}
  ctx.clearRect(0,0,W,H);drawBg();drawRoad();drawScrollBld(bldL);drawScrollBld(bldR);drawMono();
  for(var si=0;si<obstacles.length;si++){var so=obstacles[si];if(so.y+so.h<-20||so.y>H+40)continue;ctx.fillStyle='rgba(168,85,247,.03)';ctx.beginPath();ctx.ellipse(so.x+3*S,so.y+so.h/2+5*S,so.w/2,5*S,0,0,6.28);ctx.fill()}
  for(var di=0;di<obstacles.length;di++){if(obstacles[di].y+obstacles[di].h<-20||obstacles[di].y>H+40)continue;drawObs(obstacles[di])}
  if(!dead){
    var showC=!isInvincible||(frame%6<3);
    if(showC){drawCar(car.x,car.y);if(frame%3<2){var fl=(Math.random()*8+5)*S;var eg=ctx.createLinearGradient(car.x,car.y+car.h-8*S,car.x,car.y+car.h+fl);eg.addColorStop(0,'rgba(0,255,255,.6)');eg.addColorStop(.4,'rgba(168,85,247,.35)');eg.addColorStop(1,'transparent');ctx.fillStyle=eg;ctx.beginPath();ctx.moveTo(car.x-3*S,car.y+car.h-8*S);ctx.lineTo(car.x+3*S,car.y+car.h-8*S);ctx.lineTo(car.x+(Math.random()-.5)*4*S,car.y+car.h+fl);ctx.closePath();ctx.fill()}}
    if(isInvincible){ctx.save();ctx.globalAlpha=.2+Math.sin(frame*.3)*.12;ctx.strokeStyle='#ff00aa';ctx.lineWidth=2*S;if(Q){ctx.shadowColor='#ff00aa';ctx.shadowBlur=18*S}ctx.beginPath();ctx.ellipse(car.x,car.y+car.h/2-8*S,car.w/2+12*S,car.h/2+10*S,0,0,6.28);ctx.stroke();ctx.restore()}
  }
  for(var pri=0;pri<particles.length;pri++){var pp=particles[pri];ctx.save();ctx.globalAlpha=pp.life;ctx.fillStyle=pp.c;if(PARTICLE_GLOW){ctx.shadowColor=pp.c;ctx.shadowBlur=8*S}ctx.beginPath();ctx.arc(pp.x,pp.y,pp.r*pp.life,0,6.28);ctx.fill();ctx.restore()}
  var vt=ctx.createLinearGradient(0,0,0,Math.round(40*S));vt.addColorStop(0,'rgba(3,3,20,.4)');vt.addColorStop(1,'transparent');ctx.fillStyle=vt;ctx.fillRect(0,0,W,Math.round(40*S));
  requestAnimationFrame(function(){loop(gen)});
}

// ═══ 초기화: Firestore에서 글로벌 랭킹 로드 ═══
(async function init(){
  lbRenderLoading('ssLB');
  drawBg();drawRoad();drawScrollBld(bldL);drawScrollBld(bldR);
  await lbRender('ssLB',null);
})();
</script>
</body>
</html>
